<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{character.name}} - Character Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ttui_grey-900: #12181c;
            --ttui_grey-800: #232b2f;
            --ttui_grey-700: #374045;
            --ttui_grey-600: #525c63;
            --ttui_grey-500: #75838b;
            --ttui_grey-400: #a2acb2;
            --ttui_grey-300: #c4cbce;
            --ttui_grey-200: #dcdfe1;
            --ttui_grey-100: #ecedee;
            --ttui_grey-50: #f9fafa;
            --ttui_red-900: #551710;
            --ttui_red-800: #7d160f;
            --ttui_red-700: #a7080b;
            --ttui_red-600: #c50009;
            --ttui_red-500: #e40712;
            --ttui_red-400: #fe4736;
            --ttui_red-300: #ff836f;
            --ttui_red-200: #ffab9c;
            --ttui_red-100: #ffcfc7;
            --ttui_red-50: #fbedeb;
            --ttui_yellow-900: #ef7e13;
            --ttui_yellow-800: #f3a623;
            --ttui_yellow-700: #f5be2c;
            --ttui_yellow-600: #f7d635;
            --ttui_yellow-500: #f5e637;
            --ttui_yellow-400: #f8eb56;
            --ttui_yellow-300: #faef76;
            --ttui_yellow-200: #fbf49d;
            --ttui_yellow-100: #fdf8c4;
            --ttui_yellow-50: #fefde7;
            --ttui_green-900: #00703f;
            --ttui_green-800: #009158;
            --ttui_green-700: #00a365;
            --ttui_green-600: #00b674;
            --ttui_green-500: #00c680;
            --ttui_green-400: #00d093;
            --ttui_green-300: #00daa6;
            --ttui_green-200: #7be4c1;
            --ttui_green-100: #b3efd9;
            --ttui_green-50: #e0f9f0;
            --ttui_blue-900: #002e53;
            --ttui_blue-800: #004073;
            --ttui_blue-700: #00529d;
            --ttui_blue-600: #0061b3;
            --ttui_blue-500: #1c74c6;
            --ttui_blue-400: #4b8ed7;
            --ttui_blue-300: #7aaae4;
            --ttui_blue-200: #a1c3ec;
            --ttui_blue-100: #c9dbf4;
            --ttui_blue-50: #ebf1fa;
            --ttui_parchment-900: #4b4130;
            --ttui_parchment-800: #655724;
            --ttui_parchment-700: #75673b;
            --ttui_parchment-600: #8a793d;
            --ttui_parchment-500: #9c8e59;
            --ttui_parchment-400: #afa47a;
            --ttui_parchment-300: #c3bc9e;
            --ttui_parchment-200: #d7d2be;
            --ttui_parchment-100: #e8e5d9;
            --ttui_parchment-50: #f5f3ee;
            --ttui_common-0: #fff;
            --ttui_common-500: #242527;
            --ttui_common-1000: #000;
            --ttui_box-shadow-1: 0 0.063rem 0.188rem color-mix(in srgb,var(--ttui_common-1000),transparent 50%),inset 0 -0.063rem 0 color-mix(in srgb,var(--ttui_grey-800),transparent 90%);
            --ttui_box-shadow-2: 0 0.25rem 0.5rem color-mix(in srgb,var(--ttui_grey-800),transparent 50%),inset 0 -0.063rem 0 color-mix(in srgb,var(--ttui_common-1000),transparent 90%);
            --ttui_box-shadow-3: 0 0.375rem 0.75rem color-mix(in srgb,var(--ttui_common-1000),transparent 50%);
            --ttui_box-shadow-5: 0 0.75rem 2.25rem 0 color-mix(in srgb,var(--ttui_common-1000),transparent 48%);
            --ttui_focus-ring: 0 0 0 0.125rem color-mix(in srgb,var(--ttui_common-0),transparent 52%),inset 0 -0.063rem 0 color-mix(in srgb,var(--ttui_grey-800),transparent 90%);
            --ttui_underline: 0 -0.125rem 0 0 var(--ttui_red-500) inset;
            --ttui_color-primary--main: #ecedee;
            --ttui_color-primary--dark: #75838b;
            --ttui_color-primary--light: #f9fafa;
            --ttui_color-primary--contrast: #000000;
            --ttui_color-secondary--main: #00daa6;
            --ttui_color-secondary--dark: #00b674;
            --ttui_color-secondary--light: #b3efd9;
            --ttui_color-secondary--contrast: #000000;
            --ttui_color-warning--main: #ed6c02;
            --ttui_color-warning--dark: #c77700;
            --ttui_color-warning--light: #ffb547;
            --ttui_color-warning--contrast: #ffffff;
            --ttui_color-error--main: #ed6c02;
            --ttui_color-error--dark: #c77700;
            --ttui_color-error--light: #ffb547;
            --ttui_color-error--contrast: #ffffff;
            --ttui_color-info--main: #2196f3;
            --ttui_color-info--dark: #0b79d0;
            --ttui_color-info--light: #64b6f7;
            --ttui_color-info--contrast: #ffffff;
            --ttui_color-success--main: #4caf50;
            --ttui_color-success--dark: #3b873e;
            --ttui_color-success--light: #7bc67e;
            --ttui_color-success--contrast: #ffffff;
            --ttui_color-bg--paper: #12181c;
            --ttui_color-bg--default: #232b2f;
            --ttui_color-bg--pane: #12181c;
            --ttui_color-bg--scroll: #12181c;
            --ttui_color-text--primary: #ecedee;
            --ttui_color-text--secondary: #ecedee;
            --ttui_color-text--disabled: #ecedee;
            --ttui_font-tiamat: "Tiamat", serif;
            --ttui_font-tiamat-condensed: "Tiamat Condensed SC";
            --ttui_font-roboto: Roboto, Helvetica, sans-serif;
        }
        html, body {
            background: var(--ttui_parchment-50) url('https://media.dndbeyond.com/character-app/static/media/background_texture.9efbaca70f36e40effd0.png') repeat;
            color: var(--ttui_grey-900);
            font-family: 'Roboto', 'Roboto Condensed', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .sheet-container {
            max-width: 1800px;
            margin: 36px auto 36px auto;
            background: var(--ttui_common-0);
            border-radius: 22px;
            box-shadow: var(--ttui_box-shadow-3);
            padding: 0 0 36px 0;
            min-width: 320px;
            box-sizing: border-box;
            padding-left: 16px;
            padding-right: 16px;
        }
        @media (min-width: 2000px) {
            .sheet-container {
                max-width: 2100px;
            }
        }
        /* HEADER */
        .header {
            background: var(--ttui_grey-800);
            color: var(--ttui_color-text--primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 28px 48px 22px 48px;
            border-radius: 0 0 22px 22px;
            box-shadow: var(--ttui_box-shadow-2);
            margin-bottom: 32px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        .portrait {
            width: 100px;
            height: 100px;
            border-radius: 14px;
            background: #444;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--ttui_red-400);
            box-shadow: var(--ttui_box-shadow-1);
        }
        .header-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .character-name {
            font-size: 2.3rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--ttui_color-text--primary);
            font-family: 'Tiamat', 'Roboto Condensed', Arial, sans-serif;
        }
        .character-meta {
            font-size: 1.15rem;
            color: var(--ttui_grey-300);
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        .header-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }
        .header-buttons {
            display: flex;
            gap: 14px;
        }
        .rest-btn {
            background: var(--ttui_red-500);
            color: var(--ttui_common-0);
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 10px 26px;
            margin-left: 2px;
            cursor: pointer;
            box-shadow: var(--ttui_box-shadow-1);
            transition: background 0.2s;
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        .rest-btn:hover {
            background: var(--ttui_red-700);
        }
        .icon-btn {
            background: var(--ttui_common-0);
            color: var(--ttui_red-500);
            border: 2px solid var(--ttui_red-500);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-left: 8px;
            cursor: pointer;
        }
        .manage-btn {
            background: var(--ttui_grey-400);
            color: var(--ttui_grey-900);
            border: none;
            border-radius: 7px;
            font-size: 1.05rem;
            font-weight: 700;
            padding: 5px 18px;
            margin-left: 10px;
            cursor: pointer;
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        /* TOP STATS ROW */
        .stats-row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 18px;
            flex-wrap: wrap;
            max-width: 1920px;
        }
        .ability-box, .main-stat-pill {
            flex: 0 1 110px;
            background: var(--ttui_common-0);
            text-align: center;
            padding: 18px 0 12px 0;
            min-width: 110px;
            max-width: 140px;
            position: relative;
            margin: 0 4px;
            height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .main-stat-pill {
            padding: 18px 18px 12px 18px;
            height: 140px;
        }
        .main-stat-pill.hit-points-box {
            flex: 0 1 280px !important;
            max-width: 280px !important;
            min-width: 280px !important;
            height: 180px !important;
            padding: 12px 0px 20px 9px !important;
        }
        .hit-points-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 8px 0;
        }
        .hit-points-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        .hit-points-row .main-stat-value {
            font-size: 2.5rem;
            margin: 0;
            line-height: 1;
        }
        .hit-points-buttons {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        .hp-btn {
            background: var(--ttui_red-500);
            color: var(--ttui_common-0);
            border: none;
            border-radius: 4px;
            padding: 4px 12px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        .hp-btn:hover {
            background: var(--ttui_red-700);
        }
        /* Fix initiative box edge */
        .initiative-box .box-svg {
            right: -1px;
            width: calc(100% + 1px);
        }
        /* Center inspiration properly */
        .inspiration-box {
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .inspiration-box .box-svg {
            transform: scale(0.85);
            transform-origin: center;
        }
        .inspiration-box .main-stat-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0;
            height: 100%;
            position: relative;
            z-index: 2;
        }
        .inspiration-box .main-stat-label {
            font-size: 1rem;
            margin-bottom: 4px;
            letter-spacing: 1.5px;
        }
        .inspiration-box .main-stat-value {
            font-size: 2rem;
            margin: 4px 0;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }
        .inspiration-box .main-stat-value:hover {
            color: var(--ttui_red-500);
        }
        .inspiration-box .main-stat-value:active {
            transform: scale(0.95);
        }
        .ac-pill {
            margin-top: 30px;
        }
        .box-svg, .ac-svg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
            overflow: visible;
        }
        .ability-content {
            position: relative;
            z-index: 2;
            background: transparent !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        .main-stat-content {
            position: relative;
            z-index: 2;
            background: transparent !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        .hit-points-box .hit-points-values {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .hit-points-values .hp-label{
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--ttui_grey-500);
            margin-bottom: 2px;
            letter-spacing: 1px;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            text-align: center;
            width: 100%;
        }
        .hp-value-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .hp-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--ttui_grey-900);
            margin-bottom: 2px;
            letter-spacing: 1px;
            font-family: 'Tiamat', 'Roboto Condensed', Arial, sans-serif;
            text-align: center;
            width: 100%;
        }
        .ability-name {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--ttui_red-500);
            margin-bottom: 2px;
            letter-spacing: 1px;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            text-align: center;
            width: 100%;
        }
        .main-stat-label {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--ttui_red-500);
            margin-bottom: 2px;
            letter-spacing: 1px;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            text-align: center;
            width: 100%;
        }
        .ability-score {
            font-size: 2.3rem;
            font-weight: 700;
            color: var(--ttui_grey-900);
            margin-bottom: 2px;
            font-family: 'Tiamat', 'Roboto Condensed', Arial, sans-serif;
            text-align: center;
            width: 100%;
        }
        .main-stat-value {
            font-size: 2.3rem;
            font-weight: 700;
            color: var(--ttui_grey-900);
            margin-bottom: 2px;
            font-family: 'Tiamat', 'Roboto Condensed', Arial, sans-serif;
            text-align: center;
            width: 100%;
        }
        .inspiration-box .main-stat-value {
            font-size: 2rem;
            margin: 4px 0;
        }
        .hit-points-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
        }
        .ability-mod {
            font-size: 1.5rem;
            color: var(--ttui_red-500);
            font-weight: 700;
            background: var(--ttui_red-100);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px auto 0;
            border: 2px solid var(--ttui_red-500);
            box-shadow: var(--ttui_box-shadow-1);
            font-family: 'Roboto Condensed', Arial, sans-serif;
            position: relative;
            z-index: 3;
        }
        /* MAIN LAYOUT: LEFT/RIGHT */
        .main-flex {
            display: flex;
            flex-direction: row;
            gap: 32px;
            align-items: flex-start;
            justify-content: center;
            width: 100%;
            max-width: 1700px;
            margin: 0 auto;
        }
        .main-left {
            flex: 2 1 700px;
            min-width: 350px;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .main-right {
            flex: 1 1 500px;
            min-width: 350px;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        /* TABS ON RIGHT */
        .tabbed-section {
            margin-top: 0;
            padding: 0;
            background: var(--ttui_common-0);
            border-radius: 14px;
            box-shadow: var(--ttui_box-shadow-2);
            border: 2px solid var(--ttui_grey-400);
        }
        .tabs {
            display: flex;
            flex-direction: row;
            gap: 2px;
            border-bottom: 4px solid var(--ttui_red-500);
            background: var(--ttui_common-0);
            border-radius: 14px 14px 0 0;
            justify-content: flex-start;
            padding-left: 12px;
        }
        .tab {
            padding: 14px 28px;
            font-size: 1.18rem;
            font-weight: 700;
            color: var(--ttui_grey-900);
            background: var(--ttui_common-0);
            border: none;
            border-radius: 14px 14px 0 0;
            cursor: pointer;
            margin-bottom: -4px;
            border-bottom: 4px solid transparent;
            transition: color 0.2s, border-bottom 0.2s;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            text-transform: uppercase;
        }
        .tab.active {
            color: var(--ttui_red-500);
            border-bottom: 4px solid var(--ttui_red-500);
            background: var(--ttui_common-0);
        }
        .tab-content {
            background: var(--ttui_common-0);
            border-radius: 0 0 14px 14px;
            border-top: none;
            padding: 32px 36px;
            min-height: 240px;
            box-shadow: var(--ttui_box-shadow-1);
            max-height: 600px;
            overflow-y: auto;
        }
        .tab-content > div {
            height: 100%;
            overflow-y: auto;
        }
        /* GENERAL */
        @media (max-width: 1400px) {
            .sheet-container {
                max-width: 98vw;
                padding-left: 2vw;
                padding-right: 2vw;
            }
            .main-flex {
                flex-direction: column;
                gap: 18px;
            }
            .main-left, .main-right {
                max-width: 100vw;
                min-width: 0;
            }
        }
        @media (max-width: 900px) {
            .stats-row {
                flex-wrap: wrap;
                gap: 8px;
                padding: 0 2px;
            }
            .main-flex {
                flex-direction: column;
                gap: 12px;
            }
            .main-left, .main-right {
                max-width: 100vw;
                min-width: 0;
            }
        }
        .sidebar-section {
            padding: 18px 18px 12px 18px;
            margin-bottom: 16px;
            background: var(--ttui_parchment-100);
            border-radius: 10px;
            box-sizing: border-box;
            max-width: 100%;
            overflow: hidden;
        }
        .skills-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 4px;
            table-layout: fixed;
            max-width: 100%;
            box-sizing: border-box;
        }
        .skills-table th, .skills-table td {
            font-family: 'Roboto Condensed', Arial, sans-serif;
            font-size: 1.05rem;
            vertical-align: middle;
            padding: 6px 4px;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        .skills-table td.skill-icon {
            width: 28px;
            min-width: 28px;
            max-width: 28px;
            text-align: center;
            padding-right: 2px;
        }
        .skills-table td.skill-label {
            font-weight: 700;
            letter-spacing: 0.5px;
            padding-left: 2px;
        }
        .skills-table td.skill-bonus {
            font-weight: 500;
            text-align: right;
            padding-right: 6px;
        }
        .feature-list {
            padding-left: 0;
            margin: 0;
            list-style: none;
            max-width: 100%;
            box-sizing: border-box;
        }
        .feature-list li {
            font-family: 'Roboto Condensed', Arial, sans-serif;
            font-size: 1.08rem;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        .feature-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 2px;
            fill: var(--ttui_red-500);
        }
        .hit-points-box {
            flex: 0 1 340px !important;
            max-width: 340px !important;
            min-width: 340px !important;
            height: 120px !important;
            padding: 0 !important;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        .main-stat-label {
            margin-bottom: 0;
            text-align: center;
            z-index: 2;
            position: relative;
        }
        .hit-points-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 24px;
            width: 100%;
            height: 100%;
            padding: 8px 0;
        }
        .hit-points-controls {
            display: flex;
            flex-direction: column;
            width: 120px;
            padding: 0px 19px 24px 20px;
        }
        .hp-btn {
            background: var(--ttui_red-500);
            color: var(--ttui_common-0);
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            letter-spacing: 0.5px;
            width: 100%;
        }
        .hp-input {
            padding: 8px;
            border: 1px solid var(--ttui_grey-300);
            border-radius: 4px;
            text-align: center;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            font-size: 1rem;
        }
        .hit-points-values {
            flex: 1;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding-right: 24px;
        }
        .hit-points-box .box-svg {
          width: 100%;
          height: 100%;
          position: absolute;
          top: 0; left: 0;
          z-index: 1;
          pointer-events: none;
        }
        .dashboard-grid {
          display: grid;
          grid-template-columns: 300px 1.5fr 1fr 1fr 1fr 1fr;
          grid-template-rows: 99px .3fr .5fr 1fr;
          gap: 18px;
          max-width: 1920px;
          margin: 0 auto;
          padding: 0 16px;
        }
        .saving-throws {
          grid-column: 1;
          grid-row: 1 / span 2;
        }
        .senses {
          grid-column: 1;
          grid-row: 3;
        }
        .proficiencies {
          grid-column: 1;
          grid-row: 4 ;
        }
        .skills {
          grid-column: 2;
          grid-row: 1 / span 4;
        }
        .initiative {
          grid-column: 3;
          grid-row: 1;
        }
        .armor-class {
          grid-column: 4;
          grid-row: 1;
        }
        .defenses {
          grid-column: 5;
          grid-row: 1;
        }
        .conditions {
          grid-column: 6;
          grid-row: 1;
        }
        .tabbed-pane {
          grid-column: 3 / span 4;
          grid-row: 2 / span 3;
        }
        .card {
          background: #fff;
          border: 2px solid #C53131;
          border-radius: 16px;
          padding: 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.04);
          min-height: 60px;
        }
        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--ttui_grey-900);
            margin-bottom: 2px;
            letter-spacing: 1px;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            text-align: center;
            width: 100%;
        }
        .saving-throws-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          grid-template-rows: 1fr 1fr 1fr;
          grid-auto-flow: column;
          flex-wrap: wrap;
          gap: 8px;
          justify-content: center;
          margin-bottom: 16px;
        }
        .save-pill {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 4px 8px;
          border: 1px solid var(--ttui_grey-300);
          border-radius: 4px;
        }
        .save-abbr {
          font-weight: 700;
        }
        .save-bonus {
          font-size: 0.9rem;
          color: var(--ttui_grey-500);
        }
        .saving-throws-notes {
          font-size: 0.9rem;
          color: var(--ttui_grey-500);
          text-align: center;
        }
        .saving-throws-title {
          font-weight: 700;
          text-align: center;
          margin-bottom: 8px;
        }
        .settings-icon {
          font-size: 1rem;
          color: var(--ttui_grey-500);
          margin-left: 4px;
        }
        .senses-pill-row {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 8px;
        }
        .sense-pill {
          display: flex;
          align-items: center;
          border: 2px solid #C53131;
          border-radius: 16px;
          padding: 4px 12px;
          background: #fff;
          box-shadow: 0 1px 3px rgba(197,49,49,0.04);
          gap: 10px;
        }
        .sense-value {
          font-size: 1.25rem;
          font-weight: 700;
          color: var(--ttui_grey-900);
          width: 32px;
          text-align: center;
          border-radius: 50%;
          background: var(--ttui_red-50);
        }
        .sense-label {
          font-size: 0.98rem;
          font-weight: 500;
          color: var(--ttui_grey-700);
          letter-spacing: 0.5px;
        }
        .senses-additional {
          color: var(--ttui_grey-400);
          font-size: 0.98rem;
          text-align: center;
          margin: 8px 0 0 0;
        }
        .senses-title {
          font-weight: 700;
          text-align: center;
          margin-top: 8px;
          font-size: 1.08rem;
          letter-spacing: 1px;
          color: var(--ttui_grey-900);
        }
        .proficiencies-list {
          display: flex;
          flex-direction: column;
          gap: 0;
          margin-bottom: 8px;
        }
        .prof-section {
          padding: 8px 0 4px 0;
        }
        .prof-label {
          font-size: 0.98rem;
          font-weight: 700;
          color: var(--ttui_grey-800);
          letter-spacing: 0.5px;
          text-transform: uppercase;
          margin-bottom: 2px;
        }
        .prof-values {
          font-size: 1.01rem;
          color: var(--ttui_grey-900);
          font-weight: 400;
          margin-bottom: 2px;
        }
        .prof-divider {
          border-bottom: 1px solid #e0b4b4;
          margin: 0 0 0 0;
        }
        .proficiencies-title {
          font-weight: 700;
          text-align: center;
          margin-top: 10px;
          font-size: 1.08rem;
          letter-spacing: 1px;
          color: var(--ttui_grey-900);
        }
        .card.saving-throws, .card.senses, .card.proficiencies {
          display: flex;
          flex-direction: column;
          justify-content: flex-end;
        }
        .saving-throws-title, .senses-title, .proficiencies-title {
          margin-top: auto;
        }
        .skills-table-wrap {
          flex: 1;
          overflow-y: auto;
          margin-bottom: 8px;
        }
        .styled-skills-table {
          width: 100%;
          border-collapse: separate;
          border-spacing: 0 4px;
          background: none;
          table-layout: fixed;
        }
        .styled-skills-table thead th.prof-head,
        .styled-skills-table tbody td.prof-dot-cell {
          width: 40px;
          min-width: 40px;
          max-width: 40px;
          padding-left: 0;
          padding-right: 0;
        }
        .styled-skills-table thead th.skill-head,
        .styled-skills-table tbody td.skill-label {
          width: auto;
          max-width: none;
        }
        .styled-skills-table thead th.mod-head,
        .styled-skills-table tbody td.mod-abbr {
          width: 42px;
          min-width: 32px;
          max-width: 48px;
        }
        .styled-skills-table thead th.bonus-head,
        .styled-skills-table tbody td.skill-bonus-pill {
          width: 56px;
          min-width: 40px;
          max-width: 64px;
        }
        .styled-skills-table tbody tr {
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 1px 2px rgba(197,49,49,0.03);
        }
        .prof-dot-cell {
          width: 24px;
          text-align: center;
        }
        .prof-dot {
          color: var(--ttui_red-500);
          font-size: 1.1rem;
          vertical-align: middle;
        }
        .prof-dot.empty {
          color: var(--ttui_grey-300);
        }
        .mod-abbr {
          font-size: 0.95rem;
          font-weight: 700;
          color: var(--ttui_grey-500);
          width: 32px;
          text-align: center;
        }
        .skill-label {
          font-size: 1.05rem;
          color: var(--ttui_grey-900);
          font-weight: 500;
          padding-left: 2px;
        }
        .skill-bonus-pill {
          font-size: 1.05rem;
          font-weight: 700;
          color: var(--ttui_blue-700);
          background: var(--ttui_blue-50);
          border-radius: 12px;
          padding: 2px 12px;
          text-align: center;
          min-width: 36px;
          display: inline-block;
        }
        .skills-additional {
          color: var(--ttui_grey-400);
          font-size: 0.98rem;
          text-align: center;
          margin: 8px 0 0 0;
        }
        .skills-title {
          font-weight: 700;
          text-align: center;
          margin-top: auto;
          font-size: 1.08rem;
          letter-spacing: 1px;
          color: var(--ttui_grey-900);
        }
        .card.skills {
          display: flex;
          flex-direction: column;
          justify-content: flex-end;
          height: 100%;
        }
        .initiative-title {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }
        .armor-class-title {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }
        .spell-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--ttui_parchment-100);
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1em;
        }
        .spell-table thead th {
            background: var(--ttui_red-100);
            color: var(--ttui_red-700);
            font-family: 'Roboto Condensed', Arial, sans-serif;
            font-size: 1.08rem;
            font-weight: 700;
            padding: 8px 6px;
            border-bottom: 2px solid var(--ttui_red-300);
            text-align: left;
        }
        .spell-table tbody tr {
            background: #fff;
            transition: background 0.15s;
        }
        .spell-table tbody tr:hover {
            background: var(--ttui_yellow-50);
        }
        .spell-table td {
            font-family: 'Roboto Condensed', Arial, sans-serif;
            font-size: 1.01rem;
            color: var(--ttui_grey-900);
            padding: 7px 6px;
            border-bottom: 1px solid var(--ttui_parchment-200);
        }
        .spell-table tr:last-child td {
            border-bottom: none;
        }
        .spell-table th, .spell-table td {
            vertical-align: middle;
        }
        .spell-table th {
            border-top: none;
        }
        .spell-table th:nth-child(1), .spell-table td:nth-child(1) { /* Name */
            min-width: 35px;
            max-width: 40px;
        }
        .spell-table th:nth-child(2), .spell-table td:nth-child(2) { /* Time */
            min-width: 20px;
            max-width: 25px;
        }
        .spell-table th:nth-child(3), .spell-table td:nth-child(3) { /* Range */
            min-width: 20px;
            max-width: 25px;
        }
        .spell-table th:nth-child(4), .spell-table td:nth-child(4) { /* Hit / DC */
            min-width: 20px;
            max-width: 25px;
        }
        .spell-table th:nth-child(5), .spell-table td:nth-child(5) { /* Effect */
            min-width: 330px;
            max-width: 330px;
        }
        .background-tab-card {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            max-width: 900px;
            margin-top: 10px;
            max-height: 600px;
            overflow-y: auto;
        }
        .background-tab-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }
        .tab-btn {
            background: #f9fafa;
            color: #C53131;
            border: 1px solid #C53131;
            border-radius: 8px 8px 0 0;
            padding: 6px 18px;
            font-weight: 700;
            font-size: 1.08rem;
            cursor: pointer;
            margin-right: 2px;
        }
        .tab-btn.active {
            background: #fff;
            border-bottom: 2px solid #fff;
            color: #C53131;
        }
        .background-section {
            margin-bottom: 18px;
        }
        .background-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #C53131;
            margin-bottom: 4px;
        }
        .background-slash {
            color: #888;
            font-weight: 400;
        }
        .background-sub {
            color: #888;
            font-weight: 400;
            font-size: 1.1rem;
        }
        .background-feature {
            margin-bottom: 10px;
        }
        .feature-label {
            font-weight: 700;
            color: #C53131;
        }
        .feature-desc {
            color: #232b2f;
            font-size: 1.01rem;
        }
        .characteristics-section {
            margin-bottom: 18px;
        }
        .characteristics-title {
            font-size: 1.08rem;
            font-weight: 700;
            color: #C53131;
            margin-bottom: 6px;
        }
        .characteristics-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 10px;
        }
        .characteristics-table td {
            background: #f9fafa;
            border: 1px solid #e0b4b4;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 0.98rem;
            color: #232b2f;
            text-align: left;
            vertical-align: top;
        }
        .personality-section {
            margin-bottom: 8px;
        }
        .personality-title {
            font-weight: 700;
            color: #C53131;
            margin-top: 10px;
            margin-bottom: 2px;
            font-size: 1.05rem;
        }
        .personality-content ul {
            margin: 0 0 0 18px;
            padding: 0;
            font-size: 0.98rem;
            color: #232b2f;
        }
        .personality-content li {
            margin-bottom: 2px;
        }
        .char-edit-field {
            width: 90%;
            padding: 3px 6px;
            font-size: 0.98rem;
            border: 1px solid #e0b4b4;
            border-radius: 4px;
            background: #fff;
            color: #232b2f;
            margin-top: 2px;
            margin-bottom: 2px;
        }
        .dice-roller {
            background: var(--ttui_parchment-100);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }
        .dice-groups {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        .dice-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }
        .dice-group:not(:last-child)::after {
            content: '+';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ttui_grey-600);
            font-size: 1.2rem;
            font-weight: bold;
        }
        .remove-dice-btn {
            background: var(--ttui_grey-300);
            color: var(--ttui_grey-700);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .remove-dice-btn:hover {
            background: var(--ttui_red-300);
            color: white;
        }
        .add-dice-btn {
            background: var(--ttui_grey-200);
            color: var(--ttui_grey-700);
            border: 2px dashed var(--ttui_grey-300);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .add-dice-btn:hover {
            background: var(--ttui_grey-100);
            border-color: var(--ttui_red-300);
            color: var(--ttui_red-500);
        }
        .dice-roller-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--ttui_red-500);
            margin-bottom: 16px;
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        .dice-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .dice-input {
            width: 60px;
            padding: 8px;
            border: 2px solid var(--ttui_grey-300);
            border-radius: 6px;
            font-size: 1rem;
            text-align: center;
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        .dice-input:focus {
            border-color: var(--ttui_red-500);
            outline: none;
        }
        .dice-select {
            padding: 8px 12px;
            border: 2px solid var(--ttui_grey-300);
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            cursor: pointer;
        }
        .dice-select:focus {
            border-color: var(--ttui_red-500);
            outline: none;
        }
        .dice-modifier {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dice-modifier input {
            width: 60px;
            padding: 8px;
            border: 2px solid var(--ttui_grey-300);
            border-radius: 6px;
            font-size: 1rem;
            text-align: center;
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        .dice-modifier input:focus {
            border-color: var(--ttui_red-500);
            outline: none;
        }
        .roll-btn {
            background: var(--ttui_red-500);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 20px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Roboto Condensed', Arial, sans-serif;
            transition: background-color 0.2s;
        }
        .roll-btn:hover {
            background: var(--ttui_red-700);
        }
        .roll-result {
            margin-top: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 2px solid var(--ttui_grey-200);
        }
        .roll-result-title {
            font-weight: 700;
            color: var(--ttui_grey-900);
            margin-bottom: 8px;
            font-family: 'Roboto Condensed', Arial, sans-serif;
        }
        .roll-details {
            color: var(--ttui_grey-700);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .roll-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ttui_red-500);
            font-family: 'Tiamat', 'Roboto Condensed', Arial, sans-serif;
        }
        .dice-results {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .dice-result {
            background: var(--ttui_red-50);
            color: var(--ttui_red-700);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .feature-mechanics {
            margin-top: 8px;
            padding: 8px;
            background: var(--ttui_parchment-50);
            border-radius: 6px;
            border: 1px solid var(--ttui_parchment-200);
            transition: opacity 0.3s ease, max-height 0.3s ease;
        }

        /* Toggle mechanics visibility */
        .hide-mechanics .feature-mechanics {
            display: none;
        }

        /* Mechanics toggle container */
        .mechanics-toggle-container {
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--ttui_parchment-100);
            border-radius: 8px;
            border: 1px solid var(--ttui_parchment-200);
        }

        .mechanics-toggle-label {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--ttui_grey-700);
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .mechanics-toggle-checkbox {
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--ttui_red-500);
            transform: scale(1.1);
        }
        .mechanic-type {
            font-weight: 700;
            color: var(--ttui_red-700);
            margin-bottom: 4px;
        }
        .mechanic-detail {
            color: var(--ttui_grey-800);
            font-size: 0.98rem;
            margin-bottom: 2px;
            line-height: 1.4;
        }
        .mechanic-option {
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--ttui_grey-200);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .mechanic-option:hover {
            background-color: var(--ttui_grey-50);
        }
        .mechanic-description {
            margin: 8px 0;
            color: var(--ttui_grey-700);
            font-size: 0.95em;
        }
        .mechanic-effects {
            margin-top: 8px;
            color: var(--ttui_grey-800);
        }
        .mechanic-effect {
            margin: 4px 0;
            padding-left: 12px;
        }
        .mechanic-type {
            font-weight: bold;
            color: var(--ttui_red-500);
            margin-bottom: 12px;
        }
        .feature-list li {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--ttui_parchment-200);
        }
        .feature-list li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .mechanic-option.selected {
            background: var(--ttui_yellow-100);
            border-color: var(--ttui_yellow-500);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .selection-notification {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ttui_green-500);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            animation: fadeOut 2s forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Main tab system
        const tabs = document.querySelectorAll('.tabbed-section .tab');
        const tabContents = document.querySelectorAll('.tabbed-section .tab-content > div');
        tabs.forEach((tab, idx) => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach((c, i) => {
                    c.style.display = (i === idx) ? 'block' : 'none';
                });
            });
        });
        // Show only the first tab content by default
        tabContents.forEach((c, i) => c.style.display = (i === 0) ? 'block' : 'none');

        // Mechanics toggle functionality
        const mechanicsToggle = document.getElementById('hide-mechanics-checkbox');
        if (mechanicsToggle) {
            mechanicsToggle.addEventListener('change', function() {
                // Target the features tab content container directly
                const featuresContainer = document.getElementById('features-tab-content');
                if (this.checked) {
                    featuresContainer.classList.add('hide-mechanics');
                } else {
                    featuresContainer.classList.remove('hide-mechanics');
                }
            });
        }

        // Background subtabs system
        const bgTabCard = document.querySelector('.background-tab-card');
        if (bgTabCard) {
            const bgTabBtns = bgTabCard.querySelectorAll('.background-tab-bar .tab-btn');
            const bgTabContents = bgTabCard.querySelectorAll('.background-tab-content');
            bgTabBtns.forEach((btn, idx) => {
                btn.addEventListener('click', function() {
                    bgTabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    bgTabContents.forEach((c, i) => {
                        c.style.display = (i === idx) ? 'block' : 'none';
                    });
                });
            });
            // Show only the first background tab content by default
            bgTabContents.forEach((c, i) => c.style.display = (i === 0) ? 'block' : 'none');
        }
    });

    function toggleInspiration() {
        const inspirationValue = document.getElementById('inspiration-value');
        const currentValue = inspirationValue.textContent.trim();
        inspirationValue.textContent = currentValue === 'YES' ? 'NO' : 'YES';
        
        // Optional: Add a small visual feedback
        inspirationValue.style.color = currentValue === 'YES' ? 'var(--ttui_grey-900)' : 'var(--ttui_red-500)';
        setTimeout(() => {
            inspirationValue.style.color = 'var(--ttui_grey-900)';
        }, 200);
    }

    function addDiceGroup() {
        const diceGroups = document.getElementById('dice-groups');
        const newGroup = document.createElement('div');
        newGroup.className = 'dice-group';
        newGroup.innerHTML = `
            <input type="number" class="dice-input" min="1" max="100" value="1">
            <select class="dice-select">
                <option value="4">d4</option>
                <option value="6">d6</option>
                <option value="8">d8</option>
                <option value="10">d10</option>
                <option value="12">d12</option>
                <option value="20" selected>d20</option>
                <option value="100">d100</option>
            </select>
            <div class="dice-modifier">
                <span>+</span>
                <input type="number" value="0">
            </div>
            <button class="remove-dice-btn" onclick="removeDiceGroup(this)">×</button>
        `;
        diceGroups.appendChild(newGroup);

        // Show remove buttons if there's more than one group
        const removeButtons = diceGroups.querySelectorAll('.remove-dice-btn');
        removeButtons.forEach(btn => {
            btn.style.display = removeButtons.length > 1 ? 'flex' : 'none';
        });

        // Add enter key support for the new inputs
        const inputs = newGroup.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') rollDice();
            });
        });
    }

    function removeDiceGroup(button) {
        const group = button.parentElement;
        group.remove();

        // Update remove buttons visibility
        const diceGroups = document.getElementById('dice-groups');
        const removeButtons = diceGroups.querySelectorAll('.remove-dice-btn');
        removeButtons.forEach(btn => {
            btn.style.display = removeButtons.length > 1 ? 'flex' : 'none';
        });
    }

    function rollDice() {
        const diceGroups = document.querySelectorAll('.dice-group');
        let total = 0;
        let detailsText = '';
        let allResults = [];

        // Validate and collect all dice groups
        diceGroups.forEach((group, index) => {
            const count = parseInt(group.querySelector('.dice-input').value) || 1;
            const type = parseInt(group.querySelector('.dice-select').value);
            const modifier = parseInt(group.querySelector('.dice-modifier input').value) || 0;

            // Validate inputs
            if (count < 1 || count > 100) {
                alert('Please enter a number of dice between 1 and 100');
                return;
            }

            // Roll the dice for this group
            const results = [];
            let groupTotal = 0;
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * type) + 1;
                results.push(roll);
                groupTotal += roll;
            }
            groupTotal += modifier;
            total += groupTotal;

            // Add to details text
            if (index > 0) detailsText += ' + ';
            detailsText += `${count}d${type}`;
            if (modifier !== 0) {
                detailsText += modifier > 0 ? ` + ${modifier}` : ` - ${Math.abs(modifier)}`;
            }

            // Add to all results
            allResults.push({
                type: `d${type}`,
                results: results,
                modifier: modifier
            });
        });

        // Update the display
        const resultDiv = document.getElementById('roll-result');
        const detailsDiv = document.getElementById('roll-details');
        const totalDiv = document.getElementById('roll-total');
        const diceResultsDiv = document.getElementById('dice-results');

        // Show the result container
        resultDiv.style.display = 'block';

        // Update the details and total
        detailsDiv.textContent = detailsText;
        totalDiv.textContent = total;

        // Show individual dice results
        diceResultsDiv.innerHTML = '';
        allResults.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.style.marginBottom = '8px';
            
            const typeSpan = document.createElement('span');
            typeSpan.style.fontWeight = 'bold';
            typeSpan.style.color = 'var(--ttui_grey-700)';
            typeSpan.textContent = `${group.type}: `;
            groupDiv.appendChild(typeSpan);

            group.results.forEach(roll => {
                const diceResult = document.createElement('span');
                diceResult.className = 'dice-result';
                diceResult.textContent = roll;
                groupDiv.appendChild(diceResult);
            });

            if (group.modifier !== 0) {
                const modSpan = document.createElement('span');
                modSpan.style.marginLeft = '8px';
                modSpan.style.color = 'var(--ttui_grey-600)';
                modSpan.textContent = group.modifier > 0 ? `+${group.modifier}` : group.modifier;
                groupDiv.appendChild(modSpan);
            }

            diceResultsDiv.appendChild(groupDiv);
        });

        // Add animation effect
        resultDiv.style.opacity = '0';
        resultDiv.style.transform = 'translateY(10px)';
        resultDiv.style.transition = 'opacity 0.3s, transform 0.3s';
        
        setTimeout(() => {
            resultDiv.style.opacity = '1';
            resultDiv.style.transform = 'translateY(0)';
        }, 50);
    }

    // Add enter key support for initial inputs
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.dice-input, .dice-modifier input');
        inputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') rollDice();
            });
        });
    });

    function selectFeatureOption(element, featureName, optionName) {
        // Remove selected class from all options in this feature
        const featureOptions = element.parentElement.getElementsByClassName('mechanic-option');
        Array.from(featureOptions).forEach(opt => opt.classList.remove('selected'));
        
        // Add selected class to clicked option
        element.classList.add('selected');
        
        // Store the selection
        const selections = JSON.parse(localStorage.getItem('featureSelections') || '{}');
        selections[featureName] = optionName;
        localStorage.setItem('featureSelections', JSON.stringify(selections));
        
        // Visual feedback
        const notification = document.createElement('div');
        notification.className = 'selection-notification';
        notification.textContent = `Selected ${optionName}`;
        element.appendChild(notification);
        setTimeout(() => notification.remove(), 2000);
    }

    // Load saved selections on page load
    document.addEventListener('DOMContentLoaded', function() {
        const selections = JSON.parse(localStorage.getItem('featureSelections') || '{}');
        Object.entries(selections).forEach(([feature, option]) => {
            const optionElement = document.querySelector(`[data-feature="${feature}"][data-option="${option}"]`);
            if (optionElement) {
                optionElement.classList.add('selected');
            }
        });
    });
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tiamat:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tiamat+Condensed:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Tiamat';
            src: url('https://fonts.dndbeyond.com/tiamat-medium-webfont.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Tiamat Condensed SC';
            src: url('https://fonts.dndbeyond.com/tiamatcondensedsc-regular-webfont.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('https://fonts.dndbeyond.com/robotocondensed-regular-webfont.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto';
            src: url('https://fonts.dndbeyond.com/roboto-regular-webfont.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto';
            src: url('https://fonts.dndbeyond.com/roboto-bold-webfont.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }
    </style>
</head>
<body>
    <div class="sheet-container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <div class="portrait" style="background-image:url('https://www.dndbeyond.com/avatars/thumbnails/1/10/420/618/636376331930210099.png');"></div>
                <div class="header-info">
                    <span class="character-name">{{ character.name }} <button class="manage-btn">MANAGE</button></span>
                    <span class="character-meta">{{ character.race }} | {% for class_name, level in character.class_levels.items() %}{{ class_name|replace('CollegeOf', 'College of ')|replace('College', 'College ')|replace('Of', ' of ')|replace('  ', ' ') }} {{ level }}{% if not loop.last %}, {% endif %}{% endfor %} | Level {{ character.level }}</span>
                    <span class="character-meta">{{ character.background }} | {{ character.alignment }}</span>
                </div>
            </div>
            <div class="header-actions">
                <div class="header-buttons">
                    <button class="rest-btn">SHORT REST</button>
                    <button class="rest-btn">LONG REST</button>
                    <button class="icon-btn" title="Options">&#9881;</button>
                </div>
            </div>
        </div>
        <div class="stats-row">
            {% for ability, score in character.stats.items() %}
                <div class="ability-box">
                    <!-- D&D Beyond Ability Score SVG -->
                    <svg class="box-svg" viewBox="0 0 81 95" aria-hidden="true" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;"><path fill="#FEFEFE" d="M77.56,53.81a4.55,4.55,0,0,1-1.64-3.69c0-6.29-1.3-14.52,1.37-20.68A5,5,0,0,1,76,26.51a5.3,5.3,0,0,1-.72-6c1.28-2.68,1.17-6.68.88-9.54a4.15,4.15,0,0,1,1.22-3.27c.12-.62.23-1.24.35-1.86C73.47,7.49,70.86,2,70.86,2H10.14S8,6.44,4.48,6.16A5.61,5.61,0,0,1,4.63,7.5c0,1.54-.17,3.1-.21,4.66.09,1.24.23,2.47.44,3.68a33,33,0,0,1,1.58,7.78,4.58,4.58,0,0,1-1.05,3.21,4.79,4.79,0,0,1-1.47,2.34,5.17,5.17,0,0,1,.5,2.12c.18,6.94.78,13.53.25,20.5a5,5,0,0,1-1.2,3c.06,2,0,4,0,6.07a4.61,4.61,0,0,1,.44,3.71C1.64,73,6.36,78,12.35,82.16a5.16,5.16,0,0,1,.49.21c.91.5,1.81,1,2.73,1.55a1,1,0,0,0,.17.1c.54.3,1.09.59,1.66.85a2.39,2.39,0,0,1,.21.13h1.85a4.21,4.21,0,0,1-1.19-1.92,9.45,9.45,0,0,1-.9-6.13,3.71,3.71,0,0,1,.18-1.22c.16-.41.32-.79.49-1.15A10.44,10.44,0,0,1,21,70.26c.11-.12.21-.25.32-.36a14.53,14.53,0,0,1,1.91-1.84,18.26,18.26,0,0,1,6-3.17,21.13,21.13,0,0,1,4.9-1.39c6.15-1.45,14.34-.72,19.85,2.51.67.3,1.33.62,1.94,1a6.52,6.52,0,0,1,.67.45l.07,0a14.44,14.44,0,0,1,4,3.33,4.51,4.51,0,0,1,.77,1,22.47,22.47,0,0,1,1.29,1.89,4.61,4.61,0,0,1,.57,3.41,5.42,5.42,0,0,1,.27,1.78,5.73,5.73,0,0,1-.27,2.33,5.11,5.11,0,0,1-1.29,3.1,3.79,3.79,0,0,1-.66.72h2.68a4.41,4.41,0,0,1,2.21-1.49c1.34-.86,2.74-1.65,4.06-2.61,1.7-1.26,5.14-3.55,5.9-5.61A5.51,5.51,0,0,1,76.8,74a7.8,7.8,0,0,0,.37-1.71,5.4,5.4,0,0,1,.34-1.56c-.09-1.51-.18-3-.41-4.53a6.21,6.21,0,0,1,.5-3.74C77.46,59.57,77.46,56.64,77.56,53.81Z"></path><path fill="#FEFEFE" d="M40.5,66C50.7,66,59,71.61,59,78.5S50.7,91,40.5,91,22,85.39,22,78.5,30.3,66,40.5,66"></path><path fill="#C53131" d="M4.52,13.62A34.66,34.66,0,0,1,3.08,6.26l0-.42.63-.2C5.22,5.18,9.41,3.35,9.41,1V0H71.59V1c0,2.37,4.19,4.2,5.66,4.66l.63.2,0,.42a35.34,35.34,0,0,1-1.44,7.36L76,7.3C74.42,6.71,70.47,5,69.74,2H11.26C10.52,5,6.58,6.71,5,7.3ZM2.32,79.46H2.6c.08-1.12.16-2.38.24-3.76A13,13,0,0,1,.63,69.83,9.4,9.4,0,0,1,3.21,62.6V61.43S1.83,35.67.56,31.56L.4,31l.47-.29a12.31,12.31,0,0,0,2.2-1.87,6.23,6.23,0,0,0,1.55-2.24A5.08,5.08,0,0,0,5,23.27c0-.11-.58-1.35-1.12-3l-.26,2.85c.27.79.5,1.63.71,2.49a5.17,5.17,0,0,1-1.56,2A33.13,33.13,0,0,0,1.74,23.6l-.07-.2L2.91,9.63c0,2,1.38,6.53,1.38,6.53a36.23,36.23,0,0,0,2.1,6.67A7.13,7.13,0,0,1,5,28.71C6.68,38,5.08,71,4.87,74.89A15.6,15.6,0,0,1,3,71.41c.08-2,.13-4.16.16-6.41a7.57,7.57,0,0,0-1.15,4.71,12,12,0,0,0,2.1,5.41l.15.22.45.64.06.07h0a29.64,29.64,0,0,0,5.74,5.66A39.48,39.48,0,0,1,14,83.83h0l.26.18c.79.54,1.55,1.09,2.29,1.65l.18.13h0c1.42,1.09,2.71,2.17,3.78,3.11,1.39,0,2.75.11,4,.22a16.4,16.4,0,0,1-3.19-3.33H17.91l-2.49-2h2.32a16.19,16.19,0,0,1-.88-4.16,4.31,4.31,0,0,1-5.21,1.79c.59.18,3,.53,5.24-4.08v0a8.24,8.24,0,0,1,2.52-5.32,13.54,13.54,0,0,0-1,10.29A1.76,1.76,0,0,0,19.8,83,11.36,11.36,0,0,1,19,78.77c0-8.55,9.66-15.51,21.54-15.51S62,70.22,62,78.77A11.36,11.36,0,0,1,61.2,83a1.76,1.76,0,0,0,1.34-.64,13.54,13.54,0,0,0-1-10.29A8.24,8.24,0,0,1,64.1,77.4v0c2.2,4.61,4.64,4.26,5.24,4.08a4.31,4.31,0,0,1-5.21-1.79,16.19,16.19,0,0,1-.88,4.16h2.32l-2.49,2H59.68a16.4,16.4,0,0,1-3.19,3.33c1.2-.11,2.57-.21,4-.22,1.07-.94,2.36-2,3.78-3.11h0l.18-.13c.74-.56,1.5-1.11,2.29-1.65l.26-.18h0a39.48,39.48,0,0,1,3.49-2.11,29.64,29.64,0,0,0,5.74-5.66h0l.06-.07.45-.64.15-.22A12,12,0,0,0,79,69.71,7.64,7.64,0,0,0,77.8,65c0,2.25.08,4.41.16,6.41a15.6,15.6,0,0,1-1.83,3.48C75.92,71,74.32,38,76,28.71a7.1,7.1,0,0,1-1.34-5.88,38.28,38.28,0,0,0,2.09-6.67s1.4-4.48,1.38-6.53L79.33,23.4l-.07.2a33.13,33.13,0,0,0-1.07,4.08,5.39,5.39,0,0,1-1.57-2c.22-.86.45-1.7.71-2.49l-.25-2.85c-.54,1.61-1.07,2.85-1.12,3a5.08,5.08,0,0,0,.42,3.36,6.23,6.23,0,0,0,1.55,2.24,12.31,12.31,0,0,0,2.2,1.87l.48.29-.17.53c-1.26,4.11-2.64,29.87-2.64,29.87,0,.39,0,.79,0,1.17a9.4,9.4,0,0,1,2.58,7.23,13.37,13.37,0,0,1-2.2,5.89c.07,1.38.15,2.64.23,3.76h.28c1.49-.12,2.79.71,2.16,1.75a2.46,2.46,0,0,1-1.72,1.15,2.58,2.58,0,0,0,.75-.85c.17-.3,0-.44-.14-.51l-.38,0h0a7.86,7.86,0,0,0-.84,0c.18,2.31.32,3.71.33,3.79L79,85.79H66.64c-1.46,1-2.84,2.15-4,3.15a11.85,11.85,0,0,1,7,2.12l-2.75,1.09h0a30,30,0,0,1-5.35,1.74h0l-.33,0L61,94c-9.66,1.67-10.67.75-10.67.75A10.09,10.09,0,0,0,57.11,92l.23-.24c.1-.1.62-.62,1.46-1.4-.62,0-1.22.07-1.81.12h0l-.44,0a8.82,8.82,0,0,0-1.18.23,7.12,7.12,0,0,0-.87.27l-.14,0a6.24,6.24,0,0,0-1,.44l-.11.07a5.63,5.63,0,0,0-.77.54l-.22.19a4.82,4.82,0,0,0-.75.86l-7.89.9.06,0a26.18,26.18,0,0,1-6.46,0l.06,0-7.89-.9a4.5,4.5,0,0,0-.76-.86l-.22-.2a7,7,0,0,0-.79-.55l-.09-.06a8.88,8.88,0,0,0-.95-.44L26.45,91c-.3-.11-.59-.2-.86-.27-.46-.11-.86-.17-1.14-.21l-.44,0h0c-.59,0-1.19-.09-1.81-.12.84.78,1.36,1.3,1.45,1.4l.24.24a10.09,10.09,0,0,0,6.78,2.71s-1,.92-10.67-.75l-.24,0-.33,0h0a29.76,29.76,0,0,1-5.35-1.74h0l-2.75-1.09a11.85,11.85,0,0,1,7-2.12c-1.2-1-2.58-2.1-4-3.15H2l.12-1.08c0-.08.15-1.48.33-3.79a7.86,7.86,0,0,0-.84,0h0l-.38,0c-.17.07-.31.21-.14.51a2.5,2.5,0,0,0,.74.85A2.47,2.47,0,0,1,.16,81.21c-.63-1,.67-1.87,2.16-1.75ZM76.78,49.11c.53-5.66,1.25-14.21,2.15-17.46a15.6,15.6,0,0,1-1.28-1,144.6,144.6,0,0,0-.87,18.5ZM74.63,80a11.89,11.89,0,0,1,1.8-.35c0-.46-.07-1-.1-1.48-.57.67-1.15,1.28-1.7,1.83Zm-5,3.82h7.17c-.06-.66-.15-1.61-.24-2.76a18.56,18.56,0,0,0-6.93,2.76ZM58.69,92.48l.07,0c1.06.59,4.54-.45,7.31-1.59a17.09,17.09,0,0,0-5.08-.6c-1.07,1-1.88,1.72-2.3,2.14ZM40.5,92.14c7,0,13-2.55,16.48-6.35.27-.3.53-.62.78-.94a.61.61,0,0,1,.07-.1,9.16,9.16,0,0,0,.61-.92,9.74,9.74,0,0,0,1.46-5.06c0-7.37-8.7-13.37-19.4-13.37s-19.4,6-19.4,13.37a9.83,9.83,0,0,0,1.45,5.06c.19.32.4.62.62.92l.08.1c.24.32.5.64.77.94,3.43,3.8,9.52,6.35,16.48,6.35ZM20,90.34a17.09,17.09,0,0,0-5.08.6c2.78,1.14,6.25,2.18,7.31,1.59l.07,0c-.42-.42-1.22-1.18-2.3-2.14ZM4.57,79.66a12.14,12.14,0,0,1,1.8.35c-.55-.55-1.13-1.16-1.7-1.83,0,.52-.07,1-.1,1.48Zm-.35,4.17h7.17a18.62,18.62,0,0,0-6.93-2.76c-.09,1.15-.18,2.1-.24,2.76Zm0-34.72a144.6,144.6,0,0,0-.87-18.5,15.6,15.6,0,0,1-1.28,1C3,34.9,3.68,43.45,4.22,49.11Z"></path></svg>
                    <div class="ability-content">
                        <div class="ability-name">{{ {'strength':'STR','dexterity':'DEX','constitution':'CON','intelligence':'INT','wisdom':'WIS','charisma':'CHA'}[ability]|default(ability|upper) }}</div>
                        <div class="ability-score">{{ character.modifiers[ability] }}</div>
                        <div class="ability-mod">{{ score }}</div>
                    </div>
                </div>
            {% endfor %}
            <div class="main-stat-pill">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 94 89" class="ac-svg ">
                    <path fill="#FEFEFE" d="M87.54,9.45a42.28,42.28,0,0,1-3-3A42.91,42.91,0,0,0,74.21,1H18.36a11,11,0,0,0-1.53.59A4.9,4.9,0,0,1,15.36,2.7,21.09,21.09,0,0,0,6,12.28a5.14,5.14,0,0,1,.12,1.59,5.15,5.15,0,0,1,.24,1.18c1,12.72.57,25.84.4,38.59-.09,6.5,0,13-.05,19.48,0,2-.11,4.08-.22,6.12a17.93,17.93,0,0,0,2.78,2.94A73.22,73.22,0,0,0,16.51,87H78l.07-.06a32.31,32.31,0,0,0,9.31-8.5c.13-6,.65-12,.36-18s.2-11.89.36-17.9c.16-6.53,0-13.11-.17-19.64C87.84,18.57,88.07,13.86,87.54,9.45Z"></path>
                    <path fill="#C53131" d="M85,0H9L0,9.05V80l9,9H85l9-9V9.05Zm6.55,10.08v7a29.26,29.26,0,0,0-3.24-6.78v-.13h-.08a20.45,20.45,0,0,0-9.13-7.69H84ZM75.6,86.52H18.36a19,19,0,0,1-11.3-7.73V10.25A19.27,19.27,0,0,1,18.4,2.48H75.64a18.94,18.94,0,0,1,11.3,7.73V78.75A19.27,19.27,0,0,1,75.6,86.52ZM2.47,21.18a31.7,31.7,0,0,1,3.24-8.8V76.64c-.3-.53-.62-1-.89-1.62a32.92,32.92,0,0,1-2.35-7.11Zm85.82-8.82c.3.53.62,1,.89,1.62a32.92,32.92,0,0,1,2.35,7.11V67.81a31.64,31.64,0,0,1-3.24,8.81ZM10.05,2.48h4.87a20.45,20.45,0,0,0-9.13,7.69H5.71v.13a29.26,29.26,0,0,0-3.24,6.78v-7ZM2.47,78.92v-7A29.45,29.45,0,0,0,5.71,78.7v.13h.08a20.45,20.45,0,0,0,9.13,7.69H10.05ZM84,86.52H79.08a20.45,20.45,0,0,0,9.13-7.69h.08V78.7a29.45,29.45,0,0,0,3.24-6.78v7Z"></path></svg>
                <div class="main-stat-content">
                    <span class="main-stat-label">PROFICIENCY</span>
                    <span class="main-stat-value">+{{ character.proficiency_bonus }}</span>
                    <span class="main-stat-label">BONUS</span>
                </div>
            </div>
            <div class="main-stat-pill">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 94 89" class="ac-svg ">
                    <path fill="#FEFEFE" d="M87.54,9.45a42.28,42.28,0,0,1-3-3A42.91,42.91,0,0,0,74.21,1H18.36a11,11,0,0,0-1.53.59A4.9,4.9,0,0,1,15.36,2.7,21.09,21.09,0,0,0,6,12.28a5.14,5.14,0,0,1,.12,1.59,5.15,5.15,0,0,1,.24,1.18c1,12.72.57,25.84.4,38.59-.09,6.5,0,13-.05,19.48,0,2-.11,4.08-.22,6.12a17.93,17.93,0,0,0,2.78,2.94A73.22,73.22,0,0,0,16.51,87H78l.07-.06a32.31,32.31,0,0,0,9.31-8.5c.13-6,.65-12,.36-18s.2-11.89.36-17.9c.16-6.53,0-13.11-.17-19.64C87.84,18.57,88.07,13.86,87.54,9.45Z"></path>
                    <path fill="#C53131" d="M85,0H9L0,9.05V80l9,9H85l9-9V9.05Zm6.55,10.08v7a29.26,29.26,0,0,0-3.24-6.78v-.13h-.08a20.45,20.45,0,0,0-9.13-7.69H84ZM75.6,86.52H18.36a19,19,0,0,1-11.3-7.73V10.25A19.27,19.27,0,0,1,18.4,2.48H75.64a18.94,18.94,0,0,1,11.3,7.73V78.75A19.27,19.27,0,0,1,75.6,86.52ZM2.47,21.18a31.7,31.7,0,0,1,3.24-8.8V76.64c-.3-.53-.62-1-.89-1.62a32.92,32.92,0,0,1-2.35-7.11Zm85.82-8.82c.3.53.62,1,.89,1.62a32.92,32.92,0,0,1,2.35,7.11V67.81a31.64,31.64,0,0,1-3.24,8.81ZM10.05,2.48h4.87a20.45,20.45,0,0,0-9.13,7.69H5.71v.13a29.26,29.26,0,0,0-3.24,6.78v-7ZM2.47,78.92v-7A29.45,29.45,0,0,0,5.71,78.7v.13h.08a20.45,20.45,0,0,0,9.13,7.69H10.05ZM84,86.52H79.08a20.45,20.45,0,0,0,9.13-7.69h.08V78.7a29.45,29.45,0,0,0,3.24-6.78v7Z"></path></svg>
                <div class="main-stat-content">
                    <span class="main-stat-label">WALKING</span>
                    <span class="main-stat-value">{{ character.speed }} ft.</span>
                </div>
            </div>
            <div class="main-stat-pill inspiration-box">
                <svg class="box-svg" viewBox="0 0 72 54" aria-hidden="true">
                    <path fill="#FEFEFE" d="M71.73 6.16V.8H49.4l-.5.62a8.8 8.8 0 01-3 2.47 21.5 21.5 0 00-8.73-2.05 2.05 2.05 0 00-.43-1.5c-.59-.59-1.54-.59-2.13 0a2.05 2.05 0 00-.43 1.5 21.5 21.5 0 00-8.73 2.05 8.8 8.8 0 01-3-2.47l-.5-.62H0V54h22.33l.5-.62a8.8 8.8 0 013-2.47 21.5 21.5 0 008.73 2.05 2.05 2.05 0 00.43 1.5c.59.59 1.54.59 2.13 0a2.05 2.05 0 00.43-1.5 21.5 21.5 0 008.73-2.05 8.8 8.8 0 013 2.47l.5.62h22.33V6.16z"></path>
                    <path fill="#C53131" d="M71.73 0H49.4l-.5.62a8.8 8.8 0 01-3 2.47 21.5 21.5 0 00-8.73-2.05 2.05 2.05 0 00-.43-1.5c-.59-.59-1.54-.59-2.13 0a2.05 2.05 0 00-.43 1.5 21.5 21.5 0 00-8.73 2.05 8.8 8.8 0 01-3-2.47L21.72 0H0v54h22.33l.5-.62a8.8 8.8 0 013-2.47 21.5 21.5 0 008.73 2.05 2.05 2.05 0 00.43 1.5c.59.59 1.54.59 2.13 0a2.05 2.05 0 00.43-1.5 21.5 21.5 0 008.73-2.05 8.8 8.8 0 013 2.47l.5.62h22.33V0zM2 2h19.72l.5.62a10.8 10.8 0 003.69 3.03 19.5 19.5 0 018.35 1.97 4.05 4.05 0 001.1 1.84c1.18 1.18 3.08 1.18 4.26 0a4.05 4.05 0 001.1-1.84 19.5 19.5 0 018.35-1.97 10.8 10.8 0 003.69-3.03l.5-.62H70v50H53.28l-.5-.62a10.8 10.8 0 00-3.69-3.03 19.5 19.5 0 01-8.35-1.97 4.05 4.05 0 00-1.1-1.84c-1.18-1.18-3.08-1.18-4.26 0a4.05 4.05 0 00-1.1 1.84 19.5 19.5 0 01-8.35 1.97 10.8 10.8 0 00-3.69 3.03l-.5.62H2V2z"></path>
                </svg>
                <div class="main-stat-content">
                    <span class="main-stat-label">INSPIRATION</span>
                    <span class="main-stat-value" id="inspiration-value" onclick="toggleInspiration()">{% if character.inspiration %}YES{% else %}NO{% endif %}</span>
                </div>
            </div>
            <div class="main-stat-pill hit-points-box">
                <span class="main-stat-label">HIT POINTS</span>
                <svg class="box-svg" viewBox="0 0 220 145" aria-hidden="true">
                    <path fill="#FEFEFE" d="M333.54,9.45c-1.1-1.1-2.08-2.08-3-3A42.91,42.91,0,0,0,320.21,1H24.36a11,11,0,0,0-1.53.59A4.9,4.9,0,0,1,21.36,2.7,21.09,21.09,0,0,0,12,12.28a5.14,5.14,0,0,1,.12,1.59,5.15,5.15,0,0,1,.24,1.18c1,18.72.57,38.84.4,58.59-.09,8.5,0,25-.05,41.48,0,2-.11,4.08-.22,6.12a17.93,17.93,0,0,0,2.78,2.94A73.22,73.22,0,0,0,22.51,117H326l.07-.06a32.31,32.31,0,0,0,9.31-8.5c.13-6,.65-12,.36-28s.2-21.89.36-37.9c.16-16.53,0-33.11-.17-49.64C333.84,18.57,334.07,13.86,333.54,9.45Z"/>
                    <path fill="#C53131" d="M331,0H13L0,9V109.93l11.1,9H331l9-9V9ZM321.6,116.5H24.36a19,19,0,0,1-11.3-7.73V10.25A19.27,19.27,0,0,1,24.4,2.48H321.64a18.94,18.94,0,0,1,11.3,7.73V108.75A19.27,19.27,0,0,1,321.6,116.5ZM8.47,21.18a31.7,31.7,0,0,1,3.24-8.8V106.64c-.3-.53-.62-1-.89-1.62a32.92,32.92,0,0,1-2.35-7.11Zm317.82-8.82c.3.53.62,1,.89,1.62a32.92,32.92,0,0,1,2.35,7.11V97.81a31.64,31.64,0,0,1-3.24,8.81ZM18.05,2.48h4.87a20.45,20.45,0,0,0-9.13,7.69H13.71v.13a29.26,29.26,0,0,0-3.24,6.78v-7ZM8.47,108.92v-7A29.45,29.45,0,0,0,11.71,108.7v.13h.08a20.45,20.45,0,0,0,9.13,7.69H18.05ZM328,116.52h-4.92a20.45,20.45,0,0,0,9.13-7.69h.08V108.7a29.45,29.45,0,0,0,3.24-6.78v7Z"/>
                </svg>
                <div class="main-stat-content">
                    <div class="hit-points-content">
                        <div class="hit-points-controls">
                            <button class="hp-btn heal-btn">HEAL</button>
                            <input type="number" class="hp-input" min="0" placeholder="0" aria-label="Hit Points Adjustment">
                            <button class="hp-btn damage-btn">DAMAGE</button>
                        </div>
                        <div class="hit-points-values">
                            <div class="hp-value-item">
                                <label class="hp-label">Current</label>
                                <span class="hp-number">{{ character.hit_points.current }}</span>
                            </div>
                            <div class="hp-value-item">
                                <span class="hp-slash">/</span>
                            </div>
                            <div class="hp-value-item">
                                <label class="hp-label">Max</label>
                                <span class="hp-number">{{ character.hit_points.maximum }}</span>
                            </div>
                            {% if character.hit_points.temporary %}
                            <div class="hp-value-item temp">
                                <label class="hp-label">Temp</label>
                                <span class="hp-number">{{ character.hit_points.temporary }}</span>
                            </div>
                            {% else %}
                            <div class="hp-value-item temp">
                                <label class="hp-label">Temp</label>
                                <span class="hp-number temp-empty">--</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- DASHBOARD GRID LAYOUT START -->
        <div class="dashboard-grid">
          <div class="card saving-throws">
            <div class="saving-throws-grid">
              {% for ability, data in character.saving_throws.items() %}
                <div class="save-pill{% if data.proficient %} proficient{% endif %}">
                  {% if data.proficient %}
                    <span class="prof-dot">●</span>
                  {% else %}
                    <span class="prof-dot" style="visibility:hidden;">●</span>
                  {% endif %}
                  <span class="save-abbr">
                    {{ {'strength':'STR','dexterity':'DEX','constitution':'CON','intelligence':'INT','wisdom':'WIS','charisma':'CHA'}[ability]|default(ability|upper) }}
                  </span>
                  <span class="save-bonus">
                    {% set bonus = data.bonus|int %}
                    {% if bonus >= 0 %}+{% endif %}{{ bonus }}
                  </span>
                </div>
              {% endfor %}
            </div>
            <div class="saving-throws-notes">
              {% for note in character.saving_throws_notes %}
                <div class="save-note">{{ note }}</div>
              {% endfor %}
            </div>
            <div class="saving-throws-title">
              SAVING THROWS
              <span class="settings-icon">&#9881;</span>
            </div>
          </div>
          <div class="card senses">
            <div class="senses-pill-row">
              <div class="sense-pill">
                <span class="sense-value">{{ character.passive_perception }}</span>
                <span class="sense-label">PASSIVE PERCEPTION</span>
              </div>
              <div class="sense-pill">
                <span class="sense-value">{{ character.passive_investigation }}</span>
                <span class="sense-label">PASSIVE INVESTIGATION</span>
              </div>
              <div class="sense-pill">
                <span class="sense-value">{{ character.passive_insight }}</span>
                <span class="sense-label">PASSIVE INSIGHT</span>
              </div>
            </div>
            <div class="senses-title">SENSES <span class="settings-icon">&#9881;</span></div>
          </div>
          <div class="card proficiencies">
            <div class="proficiencies-list">
              <div class="prof-section">
                <div class="prof-label">ARMOR</div>
                <div class="prof-values">{{ character.proficiencies.armor|join(', ') }}</div>
              </div>
              <div class="prof-divider"></div>
              <div class="prof-section">
                <div class="prof-label">WEAPONS</div>
                <div class="prof-values">{{ character.proficiencies.weapons|join(', ') }}</div>
              </div>
              <div class="prof-divider"></div>
              <div class="prof-section">
                <div class="prof-label">TOOLS</div>
                <div class="prof-values">{{ character.proficiencies.tools|join(', ') }}</div>
              </div>
              <div class="prof-divider"></div>
              <div class="prof-section">
                <div class="prof-label">LANGUAGES</div>
                <div class="prof-values">{{ character.proficiencies.languages|join(', ') }}</div>
              </div>
            </div>
            <div class="proficiencies-title">PROFICIENCIES & TRAINING <span class="settings-icon">&#9881;</span></div>
          </div>
          <div class="card skills">
            <div class="skills-table-wrap">
              <table class="skills-table styled-skills-table">
                <thead>
                  <tr>
                    <th class="prof-head">PROF</th>
                    <th class="mod-head">MOD</th>
                    <th class="skill-head">SKILL</th>
                    <th class="bonus-head">BONUS</th>
                  </tr>
                </thead>
                <tbody>
                  {% for skill, data in character.skills.items() %}
                  <tr>
                    <td class="prof-dot-cell">{% if data.proficient %}<span class="prof-dot">●</span>{% else %}<span class="prof-dot empty">○</span>{% endif %}</td>
                    <td class="mod-abbr">{{ {'acrobatics':'DEX','animal handling':'WIS','arcana':'INT','athletics':'STR','deception':'CHA','history':'INT','insight':'WIS','intimidation':'CHA','investigation':'INT','medicine':'WIS','nature':'INT','perception':'WIS','performance':'CHA','persuasion':'CHA','religion':'INT','sleight of hand':'DEX','stealth':'DEX','survival':'WIS'}[skill]|default('') }}</td>
                    <td class="skill-label">{{ skill|title }}</td>
                    <td class="skill-bonus-pill">{{ data.bonus }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="skills-additional">Additional Skills</div>
            <div class="skills-title">SKILLS <span class="settings-icon">&#9881;</span></div>
          </div>
          <div class="card initiative">
            <div class="initiative-title">
                    <span class="main-stat-label">INITIATIVE</span>
                    <span class="main-stat-value">{{ character.initiative }}</span>
            </div>
          </div>
          <div class="card armor-class">
            <div class="armor-class-title">
                    <span class="main-stat-label">ARMOR CLASS</span>
                    <span class="main-stat-value">{{ character.armor_class }}</span>
            </div>
          </div>
          <div class="card defenses">
            <div class="card-title">Defenses</div>
          </div>
          <div class="card conditions">
            <div class="card-title">Conditions</div>
          </div>
          <div class="card tabbed-pane">
            <div class="tabbed-section">
                <div class="tabs">
                    <button class="tab active">Actions</button>
                    <button class="tab">Spells</button>
                    <button class="tab">Features & Traits</button>
                    <button class="tab">Background</button>
                    <button class="tab">Notes</button>
                    <button class="tab">Extras</button>
                </div>
                <div class="tab-content">
                    <!-- Actions Tab Content -->
                    <div>
                        <h3>Attacks & Actions</h3>
                        <table class="actions-table">
                            <thead>
                                <tr><th>Name</th><th>ATK</th><th>Range/Hit DC</th><th>Damage</th><th>Notes</th></tr>
                            </thead>
                            <tbody>
                            {% for item in character.equipment if item.type == 'weapon' %}
                                <tr>
                                    <td><strong>{{ item.name }}</strong></td>
                                    <td>{{ item.attack_bonus }}</td>
                                    <td>{% if item.range %}{{ item.range }}{% else %}-{% endif %}</td>
                                    <td>{{ item.damage }}</td>
                                    <td>{% if item.notes %}{{ item.notes }}{% else %}-{% endif %}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <div style="margin-top: 10px;">
                            <strong>Hit Dice:</strong> {{ character.hit_dice }}<br>
                            <strong>Death Saves:</strong> Successes: {{ character.death_saves.successes }} / Failures: {{ character.death_saves.failures }}
                        </div>
                    </div>
                    <!-- Spells Tab Content -->
                    <div style="max-height: 600px; overflow-y: auto; padding-right: 1em;">
                        <h3>Spellcasting</h3>
                        {% if character.spellcasting %}
                        <div style="display: flex; gap: 2em; align-items: center;">
                            <div>
                                <strong>{{ character.spellcasting.ability|upper }}</strong><br>
                                <span style="font-size: 0.9em;">SPELLCASTING ABILITY</span>
                            </div>
                            <div>
                                <strong>+{{ character.spellcasting.spell_attack_bonus }}</strong><br>
                                <span style="font-size: 0.9em;">SPELL ATTACK</span>
                            </div>
                            <div>
                                <strong>{{ character.spellcasting.spell_save_dc }}</strong><br>
                                <span style="font-size: 0.9em;">SAVE DC</span>
                            </div>
                        </div>
                        <div style="margin: 1em 0;">
                            <strong>Spellcasting Focus:</strong> {{ character.spellcasting.focus|join(', ') }}
                        </div>
                        <div class="box-label" style="margin-top:10px;">Cantrips Known ({{ character.spellcasting.cantrips_known[character.level] }})</div>
                        {% if character.spells.cantrips %}
                            <table class="spell-table" style="width:100%; margin-bottom: 1em;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Time</th>
                                        <th>Range</th>
                                        <th>Hit / DC</th>
                                        <th>Effect</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for spell in character.spells.cantrips %}
                                    <tr>
                                        <td>{{ spell.name }}</td>
                                        <td>{{ spell.casting_time or '' }}</td>
                                        <td>{{ spell.range or '' }}</td>
                                        <td>
                                            {% if spell.save_dc %}DC {{ spell.save_dc }}{% endif %}
                                            {% if spell.attack_bonus %}+{{ spell.attack_bonus }}{% endif %}
                                            {% if spell.hit_dc %}{{ spell.hit_dc }}{% endif %}
                                        </td>
                                        <td>{{ spell.effect or spell.description or '' }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            None
                        {% endif %}

                        {% for level in range(1, 10) %}
                            {% if character.spellcasting.spell_slots_per_level[character.level][level] %}
                            <div class="box-label" style="margin-top:1em;">Level {{ level }} Slots: {{ character.spellcasting.spell_slots_per_level[character.level][level] }}</div>
                            <table class="spell-table" style="width:100%; margin-bottom: 1em;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Time</th>
                                        <th>Range</th>
                                        <th>Hit / DC</th>
                                        <th>Effect</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for spell in character.spells.spells_known | selectattr('level', 'equalto', level) | list %}
                                    <tr>
                                        <td>{{ spell.name }}</td>
                                        <td>{{ spell.casting_time or '' }}</td>
                                        <td>{{ spell.range or '' }}</td>
                                        <td>
                                            {% if spell.save_dc %}DC {{ spell.save_dc }}{% endif %}
                                            {% if spell.attack_bonus %}+{{ spell.attack_bonus }}{% endif %}
                                            {% if spell.hit_dc %}{{ spell.hit_dc }}{% endif %}
                                        </td>
                                        <td>{{ spell.effect or spell.description or '' }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% endif %}
                        {% endfor %}
                        {% else %}
                        <div>No spellcasting ability.</div>
                        {% endif %}
                    </div>
                    <!-- Features & Traits Tab Content -->
                    <div id="features-tab-content">
                        <div class="mechanics-toggle-container">
                            <label for="hide-mechanics-checkbox" class="mechanics-toggle-label">
                                <input type="checkbox" id="hide-mechanics-checkbox" class="mechanics-toggle-checkbox">
                                Hide detailed mechanics
                            </label>
                        </div>
                        <h3>Class Features</h3>
                        <ul class="feature-list">
                            {% for level, features in character.class_features.items() %}
                                {% for feature in features %}
                                    {% if feature.mechanics and not (feature.mechanics.type == "subclass_feature") %}
                                    <li>
                                        <svg class="feature-icon" viewBox="0 0 20 20"><polygon points="10,2 12.59,7.36 18.51,7.64 13.97,11.47 15.45,17.27 10,14.13 4.55,17.27 6.03,11.47 1.49,7.64 7.41,7.36"/></svg>
                                        <span>
                                            <strong>{{feature.name}} (Level {{level}})</strong>: 
                                            {{feature.description}}
                                            {% if feature.mechanics and (feature.mechanics.action_type or feature.mechanics.type) %}
                                                <div class="feature-mechanics">
                                                    {% if feature.mechanics.action_type %}
                                                        <div class="mechanic-type">
                                                            {% set action_text = feature.mechanics.action_type|replace('_', ' ')|title %}
                                                            {% if action_text.endswith('Action') %}{{ action_text }}{% else %}{{ action_text }} Action{% endif %}
                                                        </div>
                                                        {% if feature.mechanics.duration %}
                                                            <div class="mechanic-detail">Duration: 
                                                                {% if feature.mechanics.duration.value %}{{feature.mechanics.duration.value}}{% elif feature.mechanics.duration.amount %}{{feature.mechanics.duration.amount}}{% else %}?{% endif %} 
                                                                {% if feature.mechanics.duration.unit %}{{feature.mechanics.duration.unit|replace('_', ' ')}}{% elif feature.mechanics.duration.amount and feature.mechanics.duration.amount != feature.mechanics.duration.value %}{{feature.mechanics.duration.amount|replace('_', ' ')}}{% else %}unit{% endif %}
                                                            </div>
                                                        {% endif %}
                                                        {% if feature.mechanics.uses %}
                                                            <div class="mechanic-detail">Uses:
                                                                {% if feature.mechanics.uses.per_day %}
                                                                    {% for level, uses in feature.mechanics.uses.per_day.items() %}
                                                                        Level {{level}}: {{uses}}{% if not loop.last %}, {% endif %}
                                                                    {% endfor %} per day
                                                                {% elif feature.mechanics.uses.per_long_rest %}
                                                                    {{feature.mechanics.uses.per_long_rest}} per long rest
                                                                {% elif feature.mechanics.uses.per_short_rest %}
                                                                    {{feature.mechanics.uses.per_short_rest}} per short rest
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                        {% if feature.mechanics.damage_bonus %}
                                                            <div class="mechanic-detail">Damage Bonus:
                                                                {% for level, bonus in feature.mechanics.damage_bonus.items() %}
                                                                    Level {{level}}: +{{bonus}}{% if not loop.last %}, {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                        {% if feature.mechanics.effects %}
                                                            {% for effect in feature.mechanics.effects %}
                                                                <div class="mechanic-detail">
                                                                    {% if effect.type == "advantage" %}
                                                                        • Advantage on {{effect.on|join(' and ')|replace('_', ' ')|title}}
                                                                    {% elif effect.type == "resistance" %}
                                                                        • Resistance to {{effect.to|join(', ')|replace('_', ' ')|title}} damage
                                                                    {% endif %}
                                                                </div>
                                                            {% endfor %}
                                                        {% endif %}
                                                        {% if feature.mechanics.conditions %}
                                                            <div class="mechanic-type">Conditions</div>
                                                            {% for condition in feature.mechanics.conditions %}
                                                                <div class="mechanic-detail">• {{condition}}</div>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% elif feature.mechanics.type %}
                                                        {% if feature.mechanics.type == "passive" %}
                                                            <div class="mechanic-type">Passive Effect</div>
                                                            {% if feature.mechanics.effects %}
                                                                {% for effect in feature.mechanics.effects %}
                                                                    <div class="mechanic-detail">
                                                                        {% if effect.name and effect.effects %}
                                                                            <!-- Nested effects with name (like Storm Soul) -->
                                                                            • <strong>{{effect.name}}:</strong>
                                                                            {% for nested_effect in effect.effects %}
                                                                                <div style="margin-left: 20px;">
                                                                                    {% if nested_effect.type == "resistance" %}
                                                                                        - Resistance to {{nested_effect.to|join(', ')}}
                                                                                    {% elif nested_effect.type == "immunity" %}
                                                                                        - Immunity to {{nested_effect.to|join(', ')|replace('_', ' ')}}
                                                                                    {% elif nested_effect.type == "water_breathing" %}
                                                                                        - Water breathing
                                                                                    {% else %}
                                                                                        - {{nested_effect.type|replace('_', ' ')|title}}
                                                                                    {% endif %}
                                                                                </div>
                                                                            {% endfor %}
                                                                        {% elif effect.type == "advantage" %}
                                                                            • Advantage on {{effect.on|replace('_', ' ')|title}}
                                                                        {% elif effect.type == "resistance" %}
                                                                            • Resistance to {{effect.to|join(', ')}}
                                                                        {% elif effect.type == "speed_bonus" %}
                                                                            • Speed bonus: +{{effect.amount}} {{effect.unit}}
                                                                        {% elif effect.type == "additional_attack" %}
                                                                            • Additional Attack: +{{effect.amount}}
                                                                        {% elif effect.type == "special" %}
                                                                            • {{effect.name|replace('_', ' ')|title}}: {{effect.description}}
                                                                        {% elif effect.type == "critical_hit_bonus" %}
                                                                            • Critical Hit Bonus: +{{effect.additional_dice.values()|list|first}} damage dice
                                                                        {% elif effect.type == "modify_feature" %}
                                                                            • Modifies {{effect.feature}} feature
                                                                        {% elif effect.type == "ability_check_minimum" %}
                                                                            • {{effect.ability|title}} check minimum: {{effect.minimum|replace('_', ' ')}}
                                                                        {% elif effect.type == "ability_score_increase" %}
                                                                            • Ability Score Increase: {{effect.abilities|join(', ')|title}} +{{effect.amount}}
                                                                        {% elif effect.type == "ability_score_maximum" %}
                                                                            • Ability Score Maximum: {{effect.abilities|join(', ')|title}} ({{effect.new_maximum}})
                                                                        {% else %}
                                                                            • {{effect.type|replace('_', ' ')|title}}
                                                                        {% endif %}
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "combat_option" %}
                                                            <div class="mechanic-type">Combat Option</div>
                                                            {% if feature.mechanics.activation %}
                                                                <div class="mechanic-detail">
                                                                    Activation: {{feature.mechanics.activation.timing|replace('_', ' ')|title}}
                                                                    {% if feature.mechanics.activation.cost and feature.mechanics.activation.cost != "free" %}
                                                                        ({{feature.mechanics.activation.cost|replace('_', ' ')|title}})
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.effects %}
                                                                {% for effect in feature.mechanics.effects %}
                                                                    <div class="mechanic-detail">
                                                                        {% if effect.type == "bonus_action" %}
                                                                            • Bonus Action: {{effect.action|replace('_', ' ')|title}}
                                                                            {% if effect.duration %}
                                                                                (Duration: {{effect.duration}})
                                                                            {% endif %}
                                                                        {% elif effect.type == "condition" %}
                                                                            • Gain {{effect.condition|title}}
                                                                            {% if effect.level %}
                                                                                (Level {{effect.level}})
                                                                            {% endif %}
                                                                            {% if effect.timing %}
                                                                                {{effect.timing|replace('_', ' ')}}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            • {{effect.type|replace('_', ' ')|title}}
                                                                            {% if effect.on %}
                                                                                : {{effect.on|replace('_', ' ')|title}}
                                                                            {% endif %}
                                                                            {% if effect.duration %}
                                                                                ({{effect.duration|replace('_', ' ')|title}})
                                                                            {% endif %}
                                                                        {% endif %}
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "choice" %}
                                                            <div class="mechanic-type">Choose {{feature.mechanics.choose|default(1)}}</div>
                                                            {% if feature.mechanics.options %}
                                                                {% for option in feature.mechanics.options %}
                                                                    <div class="mechanic-option" 
                                                                         onclick="selectFeatureOption(this, '{{feature.name}}', '{{option.name}}')"
                                                                         data-feature="{{feature.name}}"
                                                                         data-option="{{option.name}}">
                                                                        <strong>{{option.name}}</strong>
                                                                        {% if option.description %}
                                                                            <div class="mechanic-detail">{{option.description}}</div>
                                                                        {% endif %}
                                                                        {% if option.effects %}
                                                                            <div class="mechanic-effects">
                                                                                {% for effect in option.effects %}
                                                                                    <div class="mechanic-effect">
                                                                                        {% if effect.type == "advantage" %}
                                    • Advantage on {{effect.on}}
                                {% elif effect.type == "resistance" %}
                                    • Resistance to {{effect.to|join(', ')}}
                                    {% if effect.conditions %}
                                        {{effect.conditions|join(', ')}}
                                    {% endif %}
                                {% elif effect.type == "grant advantage" %}
                                    • Grant advantage on {{effect.to}}
                                    {% if effect.target %}
                                        for {{effect.target}}
                                    {% endif %}
                                    {% if effect.conditions %}
                                        when {{effect.conditions|join(' and ')}}
                                    {% endif %}
                                                                                        {% endif %}
                                                                                    </div>
                                                                                {% endfor %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "resource" %}
                                                            <div class="mechanic-type">Resource Feature</div>
                                                            {% if feature.mechanics.action_type %}
                                                                <div class="mechanic-detail">
                                                                    Action: {{feature.mechanics.action_type|replace('_', ' ')|title}}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.range %}
                                                                <div class="mechanic-detail">
                                                                    Range: {{feature.mechanics.range}} feet
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.resource %}
                                                                {% if feature.mechanics.resource.uses %}
                                                                    <div class="mechanic-detail">
                                                                        Uses: {{feature.mechanics.resource.uses.per_long_rest}} per long rest
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.resource.die %}
                                                                    <div class="mechanic-detail">
                                                                        Die: {{feature.mechanics.resource.die.values()|list|first}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}
                                                            {% if feature.mechanics.effect %}
                                                                <div class="mechanic-detail">
                                                                    Effect: {{feature.mechanics.effect.type|replace('_', ' ')|title}}
                                                                    {% if feature.mechanics.effect.duration %}
                                                                        for {{feature.mechanics.effect.duration|replace('_', ' ')}}
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "expertise" %}
                                                            <div class="mechanic-type">Expertise</div>
                                                            {% if feature.mechanics.choices %}
                                                                {% for level, choice in feature.mechanics.choices.items() %}
                                                                    <div class="mechanic-detail">
                                                                        Level {{level}}: Choose {{choice.choose}} skills to gain expertise
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "short_rest_healing" %}
                                                            <div class="mechanic-type">Short Rest Healing</div>
                                                            {% if feature.mechanics.healing %}
                                                                {% if feature.mechanics.healing.die %}
                                                                    <div class="mechanic-detail">
                                                                        Extra healing: {{feature.mechanics.healing.die.values()|list|first}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}
                                                            {% if feature.mechanics.target %}
                                                                <div class="mechanic-detail">
                                                                    Target: {{feature.mechanics.target.type|replace('_', ' ')|title}}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "subclass_choice" %}
                                                            <div class="mechanic-type">Subclass Feature</div>
                                                            {% if feature.mechanics.feature_levels %}
                                                                <div class="mechanic-detail">
                                                                    Gains features at levels: {{feature.mechanics.feature_levels|join(', ')}}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "update_resource" %}
                                                            <div class="mechanic-type">Resource Update</div>
                                                            {% if feature.mechanics.resource %}
                                                                <div class="mechanic-detail">
                                                                    Updates {{feature.mechanics.resource|replace('_', ' ')|title}}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.die %}
                                                                <div class="mechanic-detail">
                                                                    Die becomes: {{feature.mechanics.die}}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}

                                                                                                                    {% if feature.mechanics.type == "resource_recovery" %}
                                                                <div class="mechanic-type">Resource Recovery</div>
                                                                {% if feature.mechanics.resource %}
                                                                    <div class="mechanic-detail">
                                                                        Affects: {{feature.mechanics.resource|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.recovery %}
                                                                    <div class="mechanic-detail">
                                                                        Recovery: {{feature.mechanics.recovery.type|replace('_', ' ')|title}} uses on {{feature.mechanics.recovery.trigger|join(' or ')|replace('_', ' ')}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "proficiencies" %}
                                                                <div class="mechanic-type">Grants Proficiencies</div>
                                                                {% if feature.mechanics.armor %}
                                                                    <div class="mechanic-detail">
                                                                        Armor: {{feature.mechanics.armor|join(', ')|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.weapons %}
                                                                    <div class="mechanic-detail">
                                                                        Weapons: {{feature.mechanics.weapons|join(', ')|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.tools %}
                                                                    <div class="mechanic-detail">
                                                                        Tools: {{feature.mechanics.tools|join(', ')|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "modify_resource" %}
                                                                <div class="mechanic-type">Modifies {{feature.mechanics.resource|replace('_', ' ')|title}}</div>
                                                                {% if feature.mechanics.additional_uses %}
                                                                    <div class="mechanic-detail">Additional uses:</div>
                                                                    {% for use in feature.mechanics.additional_uses %}
                                                                        <div class="mechanic-detail">
                                                                            • {{use.type|replace('_', ' ')|title}}
                                                                            {% if use.trigger %}({{use.trigger|replace('_', ' ')|title}}){% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "extra_attack" %}
                                                                <div class="mechanic-type">Extra Attack</div>
                                                                <div class="mechanic-detail">
                                                                    Total attacks per turn: {{feature.mechanics.attacks}}
                                                                </div>
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "action_with_effect" or (feature.mechanics.type == "action" and feature.mechanics.effect) %}
                                                                <div class="mechanic-type">Action</div>
                                                                {% if feature.mechanics.effect %}
                                                                    {% if feature.mechanics.effect.type == "grant_advantage" %}
                                                                        <div class="mechanic-detail">
                                                                            Grants advantage on {{feature.mechanics.effect.on|join(' and ')|replace('_', ' ')|title}}
                                                                        </div>
                                                                        {% if feature.mechanics.effect.target %}
                                                                            <div class="mechanic-detail">
                                                                                Target: {{feature.mechanics.effect.target.type|join(', ')|replace('_', ' ')|title}}
                                                                                {% if feature.mechanics.effect.target.range %}
                                                                                    within {{feature.mechanics.effect.target.range}}ft
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                        {% if feature.mechanics.effect.duration %}
                                                                            <div class="mechanic-detail">
                                                                                Duration: {{feature.mechanics.effect.duration|replace('_', ' ')|title}}
                                                                            </div>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "modify_feature" %}
                                                            <div class="mechanic-type">Modifies {{feature.mechanics.feature|replace('_', ' ')|title}}</div>
                                                            {% if feature.mechanics.trigger %}
                                                                <div class="mechanic-detail">
                                                                    Trigger: {{feature.mechanics.trigger|replace('_', ' ')|title}}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.additional_effect %}
                                                                <div class="mechanic-detail">
                                                                    Additional effect: {{feature.mechanics.additional_effect.type|replace('_', ' ')|title}}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "minimum_roll" %}
                                                            <div class="mechanic-type">Minimum Roll</div>
                                                            <div class="mechanic-detail">
                                                                Minimum {{feature.mechanics.value}} on {{feature.mechanics.applies_to|join(' and ')|replace('_', ' ')|title}} checks
                                                            </div>
                                                        {% endif %}

                                                        {% if feature.mechanics.type == "combat_feature" %}
                                                            <div class="mechanic-type">Combat Feature</div>
                                                            {% if feature.mechanics.resource %}
                                                                <div class="mechanic-detail">
                                                                    Uses: {{feature.mechanics.resource|replace('_', ' ')|title}}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.options %}
                                                                {% for option in feature.mechanics.options %}
                                                                    <div class="mechanic-detail">
                                                                        <strong>{{option.name}}</strong>
                                                                        {% if option.trigger %}
                                                                            - {{option.trigger|replace('_', ' ')|title}}
                                                                        {% endif %}
                                                                        {% if option.effects %}
                                                                            {% for effect in option.effects %}
                                                                                <div style="margin-left: 12px;">
                                                                                    • {{effect.type|replace('_', ' ')|title}}
                                                                                    {% if effect.amount %}: {{effect.amount|replace('_', ' ')|title}}{% endif %}
                                                                                    {% if effect.duration %} ({{effect.duration|replace('_', ' ')|title}}){% endif %}
                                                                                </div>
                                                                            {% endfor %}
                                                                        {% endif %}
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                        </span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </ul>

                        <h3>Subclass Features</h3>
                        <ul class="feature-list">
                            {% if character.subclass_features %}
                                {% for level, features in character.subclass_features.items() %}
                                    {% for feature in features %}
                                        <li>
                                            <svg class="feature-icon" viewBox="0 0 20 20"><polygon points="10,2 12.59,7.36 18.51,7.64 13.97,11.47 15.45,17.27 10,14.13 4.55,17.27 6.03,11.47 1.49,7.64 7.41,7.36"/></svg>
                                            <span>
                                                <strong>{{feature.name}} (Level {{level}})</strong>: 
                                                {{feature.description}}
                                                {% if feature.mechanics and (feature.mechanics.action_type or feature.mechanics.type) %}
                                                    <div class="feature-mechanics">
                                                        {% if feature.mechanics.action_type %}
                                                            <div class="mechanic-type">
                                                                {% set action_text = feature.mechanics.action_type|replace('_', ' ')|title %}
                                                                {% if action_text.endswith('Action') %}{{ action_text }}{% else %}{{ action_text }} Action{% endif %}
                                                            </div>
                                                            {% if feature.mechanics.duration %}
                                                                <div class="mechanic-detail">Duration: 
                                                                    {% if feature.mechanics.duration.value %}{{feature.mechanics.duration.value}}{% elif feature.mechanics.duration.amount %}{{feature.mechanics.duration.amount}}{% else %}?{% endif %} 
                                                                    {% if feature.mechanics.duration.unit %}{{feature.mechanics.duration.unit|replace('_', ' ')}}{% elif feature.mechanics.duration.amount and feature.mechanics.duration.amount != feature.mechanics.duration.value %}{{feature.mechanics.duration.amount|replace('_', ' ')}}{% else %}unit{% endif %}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.uses %}
                                                                <div class="mechanic-detail">Uses:
                                                                    {% if feature.mechanics.uses.per_day %}
                                                                        {% for level, uses in feature.mechanics.uses.per_day.items() %}
                                                                            Level {{level}}: {{uses}}{% if not loop.last %}, {% endif %}
                                                                        {% endfor %} per day
                                                                    {% elif feature.mechanics.uses.per_long_rest %}
                                                                        {{feature.mechanics.uses.per_long_rest}} per long rest
                                                                    {% elif feature.mechanics.uses.per_short_rest %}
                                                                        {{feature.mechanics.uses.per_short_rest}} per short rest
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.damage_bonus %}
                                                                <div class="mechanic-detail">Damage Bonus:
                                                                    {% for level, bonus in feature.mechanics.damage_bonus.items() %}
                                                                        Level {{level}}: +{{bonus}}{% if not loop.last %}, {% endif %}
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                            {% if feature.mechanics.effects %}
                                                                {% for effect in feature.mechanics.effects %}
                                                                    <div class="mechanic-detail">
                                                                        {% if effect.type == "advantage" %}
                                                                            • Advantage on {{effect.on|join(' and ')|replace('_', ' ')|title}}
                                                                        {% elif effect.type == "resistance" %}
                                                                            • Resistance to {{effect.to|join(', ')|replace('_', ' ')|title}} damage
                                                                        {% endif %}
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                            {% if feature.mechanics.conditions %}
                                                                <div class="mechanic-type">Conditions</div>
                                                                {% for condition in feature.mechanics.conditions %}
                                                                    <div class="mechanic-detail">• {{condition}}</div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% elif feature.mechanics.type %}
                                                            {% if feature.mechanics.type == "passive" %}
                                                                <div class="mechanic-type">Passive Effect</div>
                                                                {% if feature.mechanics.effects %}
                                                                    {% for effect in feature.mechanics.effects %}
                                                                        <div class="mechanic-detail">
                                                                            {% if effect.name and effect.effects %}
                                                                                <!-- Nested effects with name (like Storm Soul) -->
                                                                                • <strong>{{effect.name}}:</strong>
                                                                                {% for nested_effect in effect.effects %}
                                                                                    <div style="margin-left: 20px;">
                                                                                        {% if nested_effect.type == "resistance" %}
                                                                                            - Resistance to {{nested_effect.to|join(', ')}}
                                                                                        {% elif nested_effect.type == "immunity" %}
                                                                                            - Immunity to {{nested_effect.to|join(', ')|replace('_', ' ')}}
                                                                                        {% elif nested_effect.type == "water_breathing" %}
                                                                                            - Water breathing
                                                                                        {% else %}
                                                                                            - {{nested_effect.type|replace('_', ' ')|title}}
                                                                                        {% endif %}
                                                                                    </div>
                                                                                {% endfor %}
                                                                            {% elif effect.type == "advantage" %}
                                                                                • Advantage on {{effect.on|replace('_', ' ')|title}}
                                                                            {% elif effect.type == "resistance" %}
                                                                                • Resistance to {{effect.to|join(', ')|replace('_', ' ')|title}}
                                                                                {% if effect.conditions %}
                                                                                    ({{effect.conditions|join(', ')}})
                                                                                {% endif %}
                                                                            {% elif effect.type == "immunity" %}
                                                                                • Immunity to {{effect.to|join(', ')|replace('_', ' ')|title}}
                                                                                {% if effect.conditions %}
                                                                                    ({{effect.conditions|join(', ')}})
                                                                                {% endif %}
                                                                            {% elif effect.type == "grant_advantage" %}
                                                                                • Grant advantage on {{effect.to|replace('_', ' ')|title}}
                                                                                {% if effect.target %}
                                                                                    for {{effect.target|replace('_', ' ')|title}}
                                                                                {% endif %}
                                                                                {% if effect.conditions %}
                                                                                    when {{effect.conditions|join(' and ')}}
                                                                                {% endif %}
                                                                            {% elif effect.type == "aura" %}
                                                                                • {{effect.range}}ft aura: {{effect.effect|replace('_', ' ')|title}}
                                                                                {% if effect.damage %}
                                                                                    ({{effect.damage.amount}} {{effect.damage.type}} damage)
                                                                                {% endif %}
                                                                            {% elif effect.type == "natural_weapon" %}
                                                                                • Natural weapon: {{effect.weapon.damage}} {{effect.weapon.damage_type}} damage
                                                                                {% if effect.weapon.special %}
                                                                                    - {{effect.weapon.special}}
                                                                                {% endif %}
                                                                            {% elif effect.type == "speed_bonus" %}
                                                                                • Speed +{{effect.amount}}ft
                                                                                {% if effect.conditions %}
                                                                                    ({{effect.conditions|join(', ')}})
                                                                                {% endif %}
                                                                            {% elif effect.type == "flying_speed" %}
                                                                                • Flying speed equal to {{effect.speed|replace('_', ' ')}}
                                                                            {% elif effect.type == "swimming_speed" %}
                                                                                • Swimming speed equal to {{effect.speed|replace('_', ' ')}}
                                                                            {% elif effect.type == "climbing_speed" %}
                                                                                • Climbing speed equal to {{effect.speed|replace('_', ' ')}}
                                                                            {% else %}
                                                                                • {{effect.type|replace('_', ' ')|title}}
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "combat_option" %}
                                                                <div class="mechanic-type">Combat Option</div>
                                                                {% if feature.mechanics.activation %}
                                                                    <div class="mechanic-detail">
                                                                        Activation: {{feature.mechanics.activation.timing|replace('_', ' ')|title}}
                                                                        {% if feature.mechanics.activation.cost and feature.mechanics.activation.cost != "free" %}
                                                                            ({{feature.mechanics.activation.cost|replace('_', ' ')|title}})
                                                                        {% endif %}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.effects %}
                                                                    {% for effect in feature.mechanics.effects %}
                                                                        <div class="mechanic-detail">
                                                                            {% if effect.type == "bonus_action" %}
                                                                                • Bonus Action: {{effect.action|replace('_', ' ')|title}}
                                                                                {% if effect.duration %}
                                                                                    (Duration: {{effect.duration}})
                                                                                {% endif %}
                                                                            {% elif effect.type == "condition" %}
                                                                                • Gain {{effect.condition|title}}
                                                                                {% if effect.level %}
                                                                                    (Level {{effect.level}})
                                                                                {% endif %}
                                                                                {% if effect.timing %}
                                                                                    {{effect.timing|replace('_', ' ')}}
                                                                                {% endif %}
                                                                            {% else %}
                                                                                • {{effect.type|replace('_', ' ')|title}}
                                                                                {% if effect.on %}
                                                                                    : {{effect.on|replace('_', ' ')|title}}
                                                                                {% endif %}
                                                                                {% if effect.duration %}
                                                                                    ({{effect.duration|replace('_', ' ')|title}})
                                                                                {% endif %}
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "choice" %}
                                                                <div class="mechanic-type">Choose {{feature.mechanics.choose|default(1)}}</div>
                                                                {% if feature.mechanics.options %}
                                                                    {% for option in feature.mechanics.options %}
                                                                        <div class="mechanic-option" 
                                                                             onclick="selectFeatureOption(this, '{{feature.name}}', '{{option.name}}')"
                                                                             data-feature="{{feature.name}}"
                                                                             data-option="{{option.name}}">
                                                                            <strong>{{option.name}}</strong>
                                                                            {% if option.description %}
                                                                                <div class="mechanic-detail">{{option.description}}</div>
                                                                            {% endif %}
                                                                            {% if option.effects %}
                                                                                <div class="mechanic-effects">
                                                                                    {% for effect in option.effects %}
                                                                                        <div class="mechanic-effect">
                                                                                            {% if effect.type == "advantage" %}
                                                                                                • Advantage on {{effect.on}}
                                                                                            {% elif effect.type == "resistance" %}
                                                                                                • Resistance to {{effect.to|join(', ')}}
                                                                                                {% if effect.conditions %}
                                                                                                    {{effect.conditions|join(', ')}}
                                                                                                {% endif %}
                                                                                            {% elif effect.type == "grant_advantage" %}
                                                                                                • Grant advantage on {{effect.to}}
                                                                                                {% if effect.target %}
                                                                                                    for {{effect.target}}
                                                                                                {% endif %}
                                                                                                {% if effect.conditions %}
                                                                                                    when {{effect.conditions|join(' and ')}}
                                                                                                {% endif %}
                                                                                            {% elif effect.type == "dash" %}
                                                                                                • Can use Dash as {{effect.as}}
                                                                                            {% elif effect.type == "carrying capacity" %}
                                                                                                • Carrying capacity doubled
                                                                                            {% elif effect.type == "vision" %}
                                                                                                • Extended vision: {{effect.range}}
                                                                                            {% elif effect.type == "no disadvantage" %}
                                                                                                • No disadvantage on {{effect.on}} in {{effect.in}}
                                                                                            {% elif effect.type == "tracking" %}
                                                                                                • Enhanced tracking abilities
                                                                                            {% elif effect.type == "stealth" %}
                                                                                                • Can move stealthily at {{effect.bonus}}
                                                                                            {% elif effect.type == "water_breathing" %}
                                                                                                • Can breathe underwater
                                                                                            {% elif effect.type == "aura" %}
                                                                                                • {{effect.range}}ft aura effect
                                                                                            {% else %}
                                                                                                • {{effect.type|replace('_', ' ')|title}}
                                                                                            {% endif %}
                                                                                        </div>
                                                                                    {% endfor %}
                                                                                </div>
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "reaction" %}
                                                                <div class="mechanic-type">Reaction</div>
                                                                {% if feature.mechanics.trigger %}
                                                                    <div class="mechanic-detail">
                                                                        Trigger: {{feature.mechanics.trigger|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.effects %}
                                                                    {% for effect in feature.mechanics.effects %}
                                                                        <div class="mechanic-detail">
                                                                            • {{effect.type|replace('_', ' ')|title}}
                                                                            {% if effect.target %}
                                                                                against {{effect.target|replace('_', ' ')|title}}
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "action" and not feature.mechanics.action_type %}
                                                                <div class="mechanic-type">Action</div>
                                                                {% if feature.mechanics.duration %}
                                                                    <div class="mechanic-detail">
                                                                        Duration: {{feature.mechanics.duration.amount}} {{feature.mechanics.duration.unit}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.uses %}
                                                                    <div class="mechanic-detail">
                                                                        Uses: {{feature.mechanics.uses.per_long_rest}} per long rest
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.target %}
                                                                    <div class="mechanic-detail">
                                                                        Target: {{feature.mechanics.target.type|replace('_', ' ')|title}}
                                                                        {% if feature.mechanics.target.range %}
                                                                            ({{feature.mechanics.target.range}}ft)
                                                                        {% endif %}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.effect %}
                                                                    {% if feature.mechanics.effect.type == "saving_throw" %}
                                                                        <div class="mechanic-detail">
                                                                            Saving throw: {{feature.mechanics.effect.ability|title}} (DC 8 + prof + {{feature.mechanics.effect.dc.modifiers|join(' + ')|replace('_', ' ')}})}
                                                                            {% if feature.mechanics.effect.on_fail %}
                                                                                <br>On failure: {{feature.mechanics.effect.on_fail.condition|replace('_', ' ')|title}}
                                                                                {% if feature.mechanics.effect.on_fail.duration %}
                                                                                    for {{feature.mechanics.effect.on_fail.duration|replace('_', ' ')}}
                                                                                {% endif %}
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "bonus_action" %}
                                                                <div class="mechanic-type">Bonus Action</div>
                                                                {% if feature.mechanics.effects %}
                                                                    {% for effect in feature.mechanics.effects %}
                                                                        <div class="mechanic-detail">
                                                                            • {{effect.type|replace('_', ' ')|title}}
                                                                            {% if effect.target %}
                                                                                for {{effect.target.type}} within {{effect.target.range}}ft
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                                {% if feature.mechanics.uses %}
                                                                    <div class="mechanic-detail">
                                                                        Uses: {{feature.mechanics.uses.per_long_rest}} per long rest
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "spellcasting" %}
                                                                <div class="mechanic-type">Spellcasting</div>
                                                                {% if feature.mechanics.spells %}
                                                                    {% for spell in feature.mechanics.spells %}
                                                                        <div class="mechanic-detail">
                                                                            • {{spell.name}}
                                                                            {% if spell.ritual_only %}
                                                                                (ritual only)
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "special_attack" %}
                                                                <div class="mechanic-type">Special Attack</div>
                                                                {% if feature.mechanics.trigger %}
                                                                    <div class="mechanic-detail">
                                                                        Trigger: {{feature.mechanics.trigger|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.uses %}
                                                                    <div class="mechanic-detail">
                                                                        Uses: {{feature.mechanics.uses.per_rage}} per rage
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "resource" %}
                                                                <div class="mechanic-type">Resource Feature</div>
                                                                {% if feature.mechanics.action_type %}
                                                                    <div class="mechanic-detail">
                                                                        Action: {{feature.mechanics.action_type|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.range %}
                                                                    <div class="mechanic-detail">
                                                                        Range: {{feature.mechanics.range}} feet
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.resource %}
                                                                    {% if feature.mechanics.resource.uses %}
                                                                        <div class="mechanic-detail">
                                                                            Uses: {{feature.mechanics.resource.uses.per_long_rest}} per long rest
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if feature.mechanics.resource.die %}
                                                                        <div class="mechanic-detail">
                                                                            Die: {{feature.mechanics.resource.die.values()|list|first}}
                                                                        </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                                {% if feature.mechanics.effect %}
                                                                    <div class="mechanic-detail">
                                                                        Effect: {{feature.mechanics.effect.type|replace('_', ' ')|title}}
                                                                        {% if feature.mechanics.effect.duration %}
                                                                            for {{feature.mechanics.effect.duration|replace('_', ' ')}}
                                                                        {% endif %}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "expertise" %}
                                                                <div class="mechanic-type">Expertise</div>
                                                                {% if feature.mechanics.choices %}
                                                                    {% for level, choice in feature.mechanics.choices.items() %}
                                                                        <div class="mechanic-detail">
                                                                            Level {{level}}: Choose {{choice.choose}} skills to gain expertise
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "short_rest_healing" %}
                                                                <div class="mechanic-type">Short Rest Healing</div>
                                                                {% if feature.mechanics.healing %}
                                                                    {% if feature.mechanics.healing.die %}
                                                                        <div class="mechanic-detail">
                                                                            Extra healing: {{feature.mechanics.healing.die.values()|list|first}}
                                                                        </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                                {% if feature.mechanics.target %}
                                                                    <div class="mechanic-detail">
                                                                        Target: {{feature.mechanics.target.type|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "subclass_choice" %}
                                                                <div class="mechanic-type">Subclass Feature</div>
                                                                {% if feature.mechanics.feature_levels %}
                                                                    <div class="mechanic-detail">
                                                                        Gains features at levels: {{feature.mechanics.feature_levels|join(', ')}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "update_resource" %}
                                                                <div class="mechanic-type">Resource Update</div>
                                                                {% if feature.mechanics.resource %}
                                                                    <div class="mechanic-detail">
                                                                        Updates {{feature.mechanics.resource|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.die %}
                                                                    <div class="mechanic-detail">
                                                                        Die becomes: {{feature.mechanics.die}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "resource_recovery" %}
                                                                <div class="mechanic-type">Resource Recovery</div>
                                                                {% if feature.mechanics.resource %}
                                                                    <div class="mechanic-detail">
                                                                        Affects: {{feature.mechanics.resource|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.recovery %}
                                                                    <div class="mechanic-detail">
                                                                        Recovery: {{feature.mechanics.recovery.type|replace('_', ' ')|title}} uses on {{feature.mechanics.recovery.trigger|join(' or ')|replace('_', ' ')}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "proficiencies" %}
                                                                <div class="mechanic-type">Grants Proficiencies</div>
                                                                {% if feature.mechanics.armor %}
                                                                    <div class="mechanic-detail">
                                                                        Armor: {{feature.mechanics.armor|join(', ')|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.weapons %}
                                                                    <div class="mechanic-detail">
                                                                        Weapons: {{feature.mechanics.weapons|join(', ')|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.tools %}
                                                                    <div class="mechanic-detail">
                                                                        Tools: {{feature.mechanics.tools|join(', ')|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "modify_resource" %}
                                                                <div class="mechanic-type">Modifies {{feature.mechanics.resource|replace('_', ' ')|title}}</div>
                                                                {% if feature.mechanics.additional_uses %}
                                                                    <div class="mechanic-detail">Additional uses:</div>
                                                                    {% for use in feature.mechanics.additional_uses %}
                                                                        <div class="mechanic-detail">
                                                                            • {{use.type|replace('_', ' ')|title}}
                                                                            {% if use.trigger %}({{use.trigger|replace('_', ' ')|title}}){% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "extra_attack" %}
                                                                <div class="mechanic-type">Extra Attack</div>
                                                                <div class="mechanic-detail">
                                                                    Total attacks per turn: {{feature.mechanics.attacks}}
                                                                </div>
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "action_with_effect" or (feature.mechanics.type == "action" and feature.mechanics.effect) %}
                                                                <div class="mechanic-type">Action</div>
                                                                {% if feature.mechanics.effect %}
                                                                    {% if feature.mechanics.effect.type == "grant_advantage" %}
                                                                        <div class="mechanic-detail">
                                                                            Grants advantage on {{feature.mechanics.effect.on|join(' and ')|replace('_', ' ')|title}}
                                                                        </div>
                                                                        {% if feature.mechanics.effect.target %}
                                                                            <div class="mechanic-detail">
                                                                                Target: {{feature.mechanics.effect.target.type|join(', ')|replace('_', ' ')|title}}
                                                                                {% if feature.mechanics.effect.target.range %}
                                                                                    within {{feature.mechanics.effect.target.range}}ft
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                        {% if feature.mechanics.effect.duration %}
                                                                            <div class="mechanic-detail">
                                                                                Duration: {{feature.mechanics.effect.duration|replace('_', ' ')|title}}
                                                                            </div>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "modify_feature" %}
                                                                <div class="mechanic-type">Modifies {{feature.mechanics.feature|replace('_', ' ')|title}}</div>
                                                                {% if feature.mechanics.trigger %}
                                                                    <div class="mechanic-detail">
                                                                        Trigger: {{feature.mechanics.trigger|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.additional_effect %}
                                                                    <div class="mechanic-detail">
                                                                        Additional effect: {{feature.mechanics.additional_effect.type|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "minimum_roll" %}
                                                                <div class="mechanic-type">Minimum Roll</div>
                                                                <div class="mechanic-detail">
                                                                    Minimum {{feature.mechanics.value}} on {{feature.mechanics.applies_to|join(' and ')|replace('_', ' ')|title}} checks
                                                                </div>
                                                            {% endif %}

                                                            {% if feature.mechanics.type == "combat_feature" %}
                                                                <div class="mechanic-type">Combat Feature</div>
                                                                {% if feature.mechanics.resource %}
                                                                    <div class="mechanic-detail">
                                                                        Uses: {{feature.mechanics.resource|replace('_', ' ')|title}}
                                                                    </div>
                                                                {% endif %}
                                                                {% if feature.mechanics.options %}
                                                                    {% for option in feature.mechanics.options %}
                                                                        <div class="mechanic-detail">
                                                                            <strong>{{option.name}}</strong>
                                                                            {% if option.trigger %}
                                                                                - {{option.trigger|replace('_', ' ')|title}}
                                                                            {% endif %}
                                                                            {% if option.effects %}
                                                                                {% for effect in option.effects %}
                                                                                    <div style="margin-left: 12px;">
                                                                                        • {{effect.type|replace('_', ' ')|title}}
                                                                                        {% if effect.amount %}: {{effect.amount|replace('_', ' ')|title}}{% endif %}
                                                                                        {% if effect.duration %} ({{effect.duration|replace('_', ' ')|title}}){% endif %}
                                                                                    </div>
                                                                                {% endfor %}
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </span>
                                        </li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                    <!-- Background Tab Content -->
                    <div class="background-tab-card">
                        <div class="background-tab-bar">
                            <span class="tab-btn active">ALL</span>
                            <span class="tab-btn">CHARACTERISTICS</span>
                            <span class="tab-btn">BACKGROUND</span>
                            <span class="tab-btn">APPEARANCE</span>
                        </div>
                        <!-- ALL TAB (read-only) -->
                        <div class="background-tab-content" style="display: block;">
                            <div class="background-section">
                                <div class="background-title">{{ character.background|title }}</div>
                                {% for feature in character.other_features %}
                                <div class="background-feature">
                                    <span class="feature-label">Feature: {{feature.name}}</span><br>
                                    <span class="feature-desc">{{feature.description}}</span>
                                    {% if feature.mechanics %}
                                    <div class="feature-mechanics">
                                        {% if feature.mechanics.type == "passive" %}
                                            <div class="mechanic-type">Passive Effect</div>
                                            {% if feature.mechanics.effects %}
                                                {% for effect in feature.mechanics.effects %}
                                                    <div class="mechanic-detail">
                                                        {% if effect.type == "advantage" %}
                                                            Advantage on {{effect.on|replace('_', ' ')|title}}
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                        {% endif %}
                                        {% if feature.mechanics.type == "skill_proficiency" %}
                                            <div class="mechanic-type">Skill Proficiencies</div>
                                            <div class="mechanic-detail">
                                                {{feature.mechanics.skills|join(', ')}}
                                            </div>
                                        {% endif %}
                                        {% if feature.mechanics.type == "tool_proficiency" %}
                                            <div class="mechanic-type">Tool Proficiencies</div>
                                            <div class="mechanic-detail">
                                                {{feature.mechanics.tools|join(', ')}}
                                            </div>
                                        {% endif %}
                                        {% if feature.mechanics.type == "language_proficiency" %}
                                            <div class="mechanic-type">Languages</div>
                                            <div class="mechanic-detail">
                                                {{feature.mechanics.languages|join(', ')}}
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="characteristics-section">
                                <div class="characteristics-title">CHARACTERISTICS</div>
                                <table class="characteristics-table">
                                    <tr>
                                        <td><strong>ALIGNMENT</strong><br>{{ character.alignment or 'Chaotic Good' }}</td>
                                        <td><strong>GENDER</strong><br>Male</td>
                                        <td><strong>EYES</strong><br>Blue</td>
                                        <td><strong>SIZE</strong><br>Medium</td>
                                        <td><strong>HEIGHT</strong><br>6'3"</td>
                                    </tr>
                                    <tr>
                                        <td><strong>FAITH</strong><br>Veil of Shadows</td>
                                        <td><strong>HAIR</strong><br>Long Blonde</td>
                                        <td><strong>SKIN</strong><br>White</td>
                                        <td><strong>AGE</strong><br>35</td>
                                        <td><strong>WEIGHT</strong><br>225 lb.</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="personality-section">
                                <div class="personality-title">Personality Traits</div>
                                <div class="personality-content">
                                    <ul>{% for trait in character.personality.traits %}<li>{{ trait }}</li>{% endfor %}</ul>
                                </div>
                                <div class="personality-title">Ideals</div>
                                <div class="personality-content">
                                    <ul>{% for ideal in character.personality.ideals %}<li>{{ ideal }}</li>{% endfor %}</ul>
                                </div>
                                <div class="personality-title">Bonds</div>
                                <div class="personality-content">
                                    <ul>{% for bond in character.personality.bonds %}<li>{{ bond }}</li>{% endfor %}</ul>
                                </div>
                                <div class="personality-title">Flaws</div>
                                <div class="personality-content">
                                    <ul>{% for flaw in character.personality.flaws %}<li>{{ flaw }}</li>{% endfor %}</ul>
                                </div>
                            </div>
                        </div>
                        <!-- CHARACTERISTICS TAB (read-only, same as ALL) -->
                        <div class="background-tab-content" style="display: none;">
                            <div class="characteristics-section">
                                <div class="characteristics-title">CHARACTERISTICS</div>
                                <table class="characteristics-table">
                                    <tr>
                                        <td><strong>ALIGNMENT</strong><br>{{ character.alignment or 'Chaotic Good' }}</td>
                                        <td><strong>GENDER</strong><br>Male</td>
                                        <td><strong>EYES</strong><br>Blue</td>
                                        <td><strong>SIZE</strong><br>Medium</td>
                                        <td><strong>HEIGHT</strong><br>6'3"</td>
                                    </tr>
                                    <tr>
                                        <td><strong>FAITH</strong><br>Veil of Shadows</td>
                                        <td><strong>HAIR</strong><br>Long Blonde</td>
                                        <td><strong>SKIN</strong><br>White</td>
                                        <td><strong>AGE</strong><br>35</td>
                                        <td><strong>WEIGHT</strong><br>225 lb.</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="personality-section">
                                <div class="personality-title">Personality Traits</div>
                                <div class="personality-content">
                                    <ul>{% for trait in character.personality.traits %}<li>{{ trait }}</li>{% endfor %}</ul>
                                </div>
                                <div class="personality-title">Ideals</div>
                                <div class="personality-content">
                                    <ul>{% for ideal in character.personality.ideals %}<li>{{ ideal }}</li>{% endfor %}</ul>
                                </div>
                                <div class="personality-title">Bonds</div>
                                <div class="personality-content">
                                    <ul>{% for bond in character.personality.bonds %}<li>{{ bond }}</li>{% endfor %}</ul>
                                </div>
                                <div class="personality-title">Flaws</div>
                                <div class="personality-content">
                                    <ul>{% for flaw in character.personality.flaws %}<li>{{ flaw }}</li>{% endfor %}</ul>
                                </div>
                            </div>
                        </div>
                        <!-- BACKGROUND TAB (display only) -->
                        <div class="background-tab-content" style="display: none;">
                            <div class="background-section">
                                <div class="background-title">{{ character.background|title }}</div>
                                {% for feature in character.other_features %}
                                <div class="background-feature">
                                    <span class="feature-label">Feature: {{feature.name}}</span><br>
                                    <span class="feature-desc">{{feature.description}}</span>
                                    {% if feature.mechanics %}
                                    <div class="feature-mechanics">
                                        {% if feature.mechanics.type == "passive" %}
                                            <div class="mechanic-type">Passive Effect</div>
                                            {% if feature.mechanics.effects %}
                                                {% for effect in feature.mechanics.effects %}
                                                    <div class="mechanic-detail">
                                                        {% if effect.type == "advantage" %}
                                                            Advantage on {{effect.on|replace('_', ' ')|title}}
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                        {% endif %}
                                        {% if feature.mechanics.type == "skill_proficiency" %}
                                            <div class="mechanic-type">Skill Proficiencies</div>
                                            <div class="mechanic-detail">
                                                {{feature.mechanics.skills|join(', ')}}
                                            </div>
                                        {% endif %}
                                        {% if feature.mechanics.type == "tool_proficiency" %}
                                            <div class="mechanic-type">Tool Proficiencies</div>
                                            <div class="mechanic-detail">
                                                {{feature.mechanics.tools|join(', ')}}
                                            </div>
                                        {% endif %}
                                        {% if feature.mechanics.type == "language_proficiency" %}
                                            <div class="mechanic-type">Languages</div>
                                            <div class="mechanic-detail">
                                                {{feature.mechanics.languages|join(', ')}}
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="background-desc">
                                <strong>Description:</strong><br>
                                <span>{{ character.background_description }}</span>
                            </div>
                        </div>
                        <!-- APPEARANCE TAB (display only) -->
                        <div class="background-tab-content" style="display: none;">
                            <div class="appearance-section">
                                <div class="characteristics-title">APPEARANCE</div>
                                <table class="characteristics-table">
                                    <tr>
                                        <td><strong>GENDER</strong><br>Male</td>
                                        <td><strong>EYES</strong><br>Blue</td>
                                        <td><strong>HAIR</strong><br>Long Blonde</td>
                                        <td><strong>SKIN</strong><br>White</td>
                                    </tr>
                                    <tr>
                                        <td><strong>HEIGHT</strong><br>6'3"</td>
                                        <td><strong>WEIGHT</strong><br>225 lb.</td>
                                        <td><strong>AGE</strong><br>35</td>
                                        <td><strong>SIZE</strong><br>Medium</td>
                                    </tr>
                                </table>
                                <div class="appearance-notes">
                                    <strong>Additional Appearance Notes:</strong><br>
                                    <span>Describe scars, tattoos, distinguishing features, clothing style, or other details here. (Edit in your Python app.)</span>
                                </div>
                            </div>
                        </div>
                        <!-- Other tabs (BACKGROUND, APPEARANCE) can be filled in as needed -->
                    </div>
                    <!-- Notes Tab Content -->
                    <div>
                        <h3>Notes</h3>
                        <div style="color:#888;">Add your notes here...</div>
                    </div>
                    <!-- Extras Tab Content -->
                    <div>
                        <h3>Extras</h3>
                        <div class="dice-roller">
                            <div class="dice-roller-title">Dice Roller</div>
                            <div id="dice-groups" class="dice-groups">
                                <div class="dice-group">
                                    <input type="number" class="dice-input" min="1" max="100" value="1">
                                    <select class="dice-select">
                                        <option value="4">d4</option>
                                        <option value="6">d6</option>
                                        <option value="8">d8</option>
                                        <option value="10">d10</option>
                                        <option value="12">d12</option>
                                        <option value="20" selected>d20</option>
                                        <option value="100">d100</option>
                                    </select>
                                    <div class="dice-modifier">
                                        <span>+</span>
                                        <input type="number" value="0">
                                    </div>
                                    <button class="remove-dice-btn" onclick="removeDiceGroup(this)" style="display: none;">×</button>
                                </div>
                            </div>
                            <button class="add-dice-btn" onclick="addDiceGroup()">
                                <span>+</span> Add Dice
                            </button>
                            <div class="dice-input-group" style="margin-top: 16px;">
                                <button class="roll-btn" onclick="rollDice()">ROLL</button>
                            </div>
                            <div id="roll-result" class="roll-result" style="display: none;">
                                <div class="roll-result-title">Roll Result</div>
                                <div id="roll-details" class="roll-details"></div>
                                <div id="roll-total" class="roll-total"></div>
                                <div id="dice-results" class="dice-results"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>
    </div>
</body>
</html> 